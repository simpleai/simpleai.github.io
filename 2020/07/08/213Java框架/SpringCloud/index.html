<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.xiaoruiit.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="SpringCloud">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="http://blog.xiaoruiit.com/2020/07/08/213Java%E6%A1%86%E6%9E%B6/SpringCloud/index.html">
<meta property="og:site_name" content="Go after">
<meta property="og:description" content="SpringCloud">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/uZvoRUhxaAidn6J.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/IA7JXV2x534i8ky.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/VBlXvnP7RG15dzM.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/ebrgMFzcd8GhmJw.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/QL6duYOJbgrkRpw.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/cRrm9WThZQDiFqg.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/RCZQ4m7iXcJLStD.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/5wWpve8kFYgVS39.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/hByRiAwsb7TYZKJ.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/2XJKcliYNa4orgQ.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/6sQtEHn1d2AibeK.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/IfNkQzc7jabWJBZ.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/zO37WGxuEXsCfmi.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/RiTYUtd58LmXC7e.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Kou9hgpeLmkcZFC.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/BgYNVWQMaxzSJrt.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/zecDQKGs8IHd64n.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Za3zqJMVkTHtGsN.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/qUYIulMLEQc4Be7.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/x87jf13ZR4sUMGp.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/wpSfXP5nhziZxlR.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/SmIK6hzpMntxucF.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/me4O8Vz79xwaHu1.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/jH7dbni4Z9XAwMC.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Ff2jsbUyaqguJm4.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/I5OrxevYB9oPqf3.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/dhXtnCGfoASHxFl.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/NDAQT59pO3SBIuo.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/rcfAFk4eyGJHN2X.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Fb3B6cDGIEUQ48Y.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/hkiHbjWJ2cBzn8U.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/ci4ITNDCKZbkBQM.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/gwBoQZT7CUGthS8.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/EBPzcNUxupmlZFf.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/azXZFPB4LtCkHSx.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Nb7PvQVeIzUTXMB.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/TtcCsGaJpfY3dqX.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/JN1Gg5CbQ8maZov.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/HVl6ZXDU7MoWrpg.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/98314Edx7vDbYsp.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Z2Br69nzmhYXpx4.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/N2kSujzBtmGxC3i.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/WsMCDPGHZa3xVER.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/rENSnD2kHyp7UYQ.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/XdT9whlAurJ5H7q.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/2pLJDeRSGi4NWKg.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Z3HPVsqb5EUteAR.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/qkNpvbTioxBKyPE.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/4843e7f2f94bb2d2f2a19fc973a5f21.jpg">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/nxyI5Q34c7VdWPs.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/upX2MQVylkYBsrN.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/sWtRIoHXpZx8y1h.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/DSk5GjTXYl7FQBn.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/zxDkd8cNZK4FeBn.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/rb5SG9kuczNo3Uy.png">
<meta property="og:image" content="c:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20210713171323964.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/ZVtFojsAMT1Jhrb.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/K3mRMefYSzPIavo.png">
<meta property="og:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/pxrasmLu1MYvRcS.png">
<meta property="article:published_time" content="2020-07-07T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-15T01:11:25.696Z">
<meta property="article:author" content="追逐">
<meta property="article:tag" content="入门">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/uZvoRUhxaAidn6J.png">

<link rel="canonical" href="http://blog.xiaoruiit.com/2020/07/08/213Java%E6%A1%86%E6%9E%B6/SpringCloud/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringCloud | Go after</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Go after</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.xiaoruiit.com/2020/07/08/213Java%E6%A1%86%E6%9E%B6/SpringCloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="追逐">
      <meta itemprop="description" content="技术融于生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Go after">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCloud
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-08 00:00:00" itemprop="dateCreated datePublished" datetime="2020-07-08T00:00:00+08:00">2020-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-15 09:11:25" itemprop="dateModified" datetime="2024-03-15T09:11:25+08:00">2024-03-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringCloud/" itemprop="url" rel="index"><span itemprop="name">SpringCloud</span></a>
                </span>
            </span>

          
            <span id="/2020/07/08/213Java%E6%A1%86%E6%9E%B6/SpringCloud/" class="post-meta-item leancloud_visitors" data-flag-title="SpringCloud" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>68k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:02</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>SpringCloud</p>
<span id="more"></span>

<h1 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h1><p><strong>描述：</strong>一套完整的微服务解决方案，一系列不同功能的微服务框架的集合。</p>
<p><strong>类别：</strong>Netflix（奈飞），Alibaba</p>
<p>源码：<a target="_blank" rel="noopener" href="https://github.com/qiyisoft/sca">https://github.com/qiyisoft/sca</a></p>
<h2 id="各个组件"><a href="#各个组件" class="headerlink" title="各个组件"></a>各个组件</h2><ol>
<li>Nacos</li>
<li>Ribbon</li>
<li>OpenFeign</li>
<li>GateWay</li>
<li>Sentinel</li>
<li>SkyWalking</li>
<li>Seata</li>
<li>分布式锁</li>
<li>认证与授权  OAuth2+JWT+Security</li>
</ol>
<h3 id="1-注册中心Nacos"><a href="#1-注册中心Nacos" class="headerlink" title="1.注册中心Nacos"></a>1.注册中心Nacos</h3><p>特性，Nacos使用，Nacos的心跳机制和健康检查</p>
<h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><p><strong>出现的背景：</strong>在以往单实例情况下，服务间通常采用点对点通信，即采用 IP+端口+接口的形式直接调用。考虑避免单点负载压力过大以及高可用的性能要求，通常会部署多实例节点保障系统的性能，但增加多实例后，调用方该如何选择哪个服务提供者进行处理呢？还有当服务提供者出现故障后，如何将后续请求转移到其他可用实例上呢？</p>
<p><strong>功能：</strong></p>
<ul>
<li><p>服务发现与管理</p>
</li>
<li><p>动态配置服务</p>
</li>
<li><p>动态DNS服务</p>
</li>
</ul>
<h4 id="Nacos注册中心使用"><a href="#Nacos注册中心使用" class="headerlink" title="Nacos注册中心使用"></a>Nacos注册中心使用</h4><h5 id="服务端部署"><a href="#服务端部署" class="headerlink" title="服务端部署"></a>服务端部署</h5><ol>
<li><p>环境准备</p>
<ol>
<li><p>操作系统CentOS7</p>
</li>
<li><p>安装JDK8</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk-devel.x86_64 # 默认安装位置： /usr/lib/jvm/</span><br><span class="line"># 安装成功后验证Java版本</span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"># 编辑profile配置 JAVA_HOME 环境变量</span><br><span class="line">[root@server-1 ~]# vim /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class="line">export JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">export CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH</span><br><span class="line">export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH</span><br><span class="line"># source:在当前bash环境下读取并执行FileName中的命令。</span><br><span class="line">[root@server-1 ~]# source /etc/profile</span><br><span class="line"></span><br><span class="line"># 验证配置是否正确 ? java javac</span><br><span class="line">[root@server-1 ~]# echo $JAVA_HOME</span><br><span class="line">/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>安装并启动</p>
<ol>
<li><p>获取安装包</p>
<p>访问 Nacos GitHub：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases/%E8%8E%B7%E5%8F%96">https://github.com/alibaba/nacos/releases/获取</a> Nacos 安装包 nacos-server-1.4.0.tar.gz。</p>
</li>
<li><p>上传&amp;解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server-1 local]#  tar -xvf nacos-server-1.4.0.tar.gz</span><br></pre></td></tr></table></figure></li>
<li><p>启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server-1 local]# cd nacos/bin</span><br><span class="line"># 以单点方式启动 Nacos</span><br><span class="line">[root@server-1 bin]# sh startup.sh -m standalone</span><br></pre></td></tr></table></figure>

<p>Nacos默认以后台模式启动，利用 tail 命令查看启动日志。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server-1 bin]# tail -f /usr/local/nacos/logs/start.out</span><br><span class="line">2020-12-06 21:03:18,759 INFO Tomcat started on port(s): 8848 (http) with context path &#x27;/nacos&#x27;</span><br><span class="line">2020-12-06 21:03:18,766 INFO Nacos Log files: /usr/local/nacos/nacos/logs</span><br><span class="line">2020-12-06 21:03:18,766 INFO Nacos Log files: /usr/loca/nacos/nacos/conf</span><br><span class="line">2020-12-06 21:03:18,766 INFO Nacos Log files: /usr/local/nacos/nacos/data</span><br><span class="line">2020-12-06 21:03:18,767 INFO Nacos started successfully in stand alone mode. use embedded storage</span><br></pre></td></tr></table></figure></li>
<li><p>对外开放7848/8848端口</p>
<p>8848 端口是 Nacos 对客户端提供服务的端口，7848 是 Nacos 集群通信端口，用于Nacos 集群间进行选举，检测等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server-1 bin]# firewall-cmd --zone=public --add-port=8848/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@server-1 bin]# firewall-cmd --zone=public --add-port=7848/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@server-1 bin]# firewall-cmd  --reload</span><br><span class="line">success</span><br></pre></td></tr></table></figure></li>
<li><p>从浏览器进入管理界面</p>
<p><a target="_blank" rel="noopener" href="http://192.168.31.102:8848/nacos">http://192.168.31.102:8848/nacos</a></p>
<p>账号&amp;密码 nacos&amp;nacos</p>
<p>服务管理-&gt;服务列表，用于查看已注册微服务列表。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/uZvoRUhxaAidn6J.png" alt="image-20210704204632363"></p>
</li>
</ol>
</li>
</ol>
<h5 id="微服务接入nacos"><a href="#微服务接入nacos" class="headerlink" title="微服务接入nacos"></a>微服务接入nacos</h5><ol>
<li><p>创建项目</p>
<p>idea工具，创建项目，选择Spring InitiaLizr</p>
<p>Custom可以选择阿里云镜像地址 <a target="_blank" rel="noopener" href="http://start.aliyun.com/">http://start.aliyun.com</a></p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/IA7JXV2x534i8ky.png" alt="image-20210705063904157"></p>
</li>
<li><p>添加依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- nacos依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- web 使微服务具备http相应能力 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置nacos相关属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 应用名称，默认也是在微服务中注册的微服务 ID</span><br><span class="line">spring.application.name=sample-service</span><br><span class="line"># 配置 Nacos 服务器的IP地址</span><br><span class="line">spring.cloud.nacos.discovery.server-addr=192.168.31.102:8848</span><br><span class="line">#连接 Nacos 服务器使用的用户名、密码，默认为 nacos</span><br><span class="line">spring.cloud.nacos.discovery.username=nacos</span><br><span class="line">spring.cloud.nacos.discvery.password=nacos</span><br><span class="line">#微服务提供Web服务的端口号</span><br><span class="line">server.port=8081</span><br></pre></td></tr></table></figure></li>
<li><p>启动项目</p>
<p>启动日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#Web 服务端口号 8081</span><br><span class="line">INFO 14188 o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8081 (http) with context path &#x27;&#x27;</span><br><span class="line">#微服务向 Nacos 注册成功，微服务 ID:sample-service</span><br><span class="line">INFO 14188  c.a.c.n.registry.NacosServiceRegistry    : nacos registry, DEFAULT_GROUP sample-service 192.168.47.1:8081 register finished</span><br><span class="line">#微服务启动成功</span><br><span class="line">INFO 14188  c.l.s.SampleServiceApplication           : Started SampleServiceApplication in 4.911 seconds (JVM running for 6.039)</span><br></pre></td></tr></table></figure></li>
<li><p>nacos查看刚刚注册的项目</p>
<p>浏览器打开 <a target="_blank" rel="noopener" href="http://192.168.31.102:8848/nacos">http://192.168.31.102:8848/nacos</a> ，服务管理-服务列表</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/VBlXvnP7RG15dzM.png" alt="image-20210705065001740"></p>
</li>
</ol>
<h4 id="Nacos配置中心"><a href="#Nacos配置中心" class="headerlink" title="Nacos配置中心"></a>Nacos配置中心</h4><h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>场景：</p>
<ul>
<li>动态配置，无需重启服务</li>
<li>多实例批量修改</li>
<li>版本管理</li>
<li>配置文件多环境切换</li>
<li>变更推送</li>
<li>监听查询？</li>
</ul>
<p>微服务应用只持有应用启动的最小化配置，在应用启动时微服务应用所需的其他配置数据，诸如数据库连接字符串、各种用户名密码、IP 等信息均从配置中心远程下载。书写应用配置时不直接写入 application.yml 配置，而是直接在配置中心提供的 UI 进行设置。</p>
<h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><h6 id="部署配置中心"><a href="#部署配置中心" class="headerlink" title="部署配置中心"></a>部署配置中心</h6><ol>
<li><p>下载Nacos</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf nacos-server-1.4.0.tar.gz</span><br></pre></td></tr></table></figure></li>
<li><p>配置数据库，执行/nacos/conf/nacos-mysql.sql</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/ebrgMFzcd8GhmJw.png" alt="image-20210715174758339"></p>
</li>
<li><p>配置Nacos数据源</p>
<p>打开 /usr/local/nacos/conf/application.properties，36行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">### Count of DB: 数据库总数</span><br><span class="line">db.num=1</span><br><span class="line">### Connect URL of DB: 数据库连接,根据你的实际情况调整</span><br><span class="line">db.url.0=jdbc:mysql://192.168.31.10:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class="line">db.user=root</span><br><span class="line">db.password=root</span><br></pre></td></tr></table></figure></li>
<li><p>添加所有 Nacos 集群节点 IP 及端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 复制命令创建 cluster.conf 文件</span><br><span class="line">cp cluster.conf.example cluster.conf</span><br><span class="line"># 打开 cluster.conf，添加所有 Nacos 集群节点 IP 及端口</span><br><span class="line">vim cluster.conf</span><br><span class="line">192.168.31.10:8848</span><br></pre></td></tr></table></figure></li>
<li><p>按集群模式启动 Nacos</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /usr/local/nacos/bin/startup.sh</span><br></pre></td></tr></table></figure></li>
<li><p>访问配置页面</p>
<p><a target="_blank" rel="noopener" href="http://192.168.31.10:8848/nacos/#/configurationManagement">http://192.168.31.10:8848/nacos/#/configurationManagement</a></p>
</li>
</ol>
<h6 id="微服务接入配置中心"><a href="#微服务接入配置中心" class="headerlink" title="微服务接入配置中心"></a>微服务接入配置中心</h6><ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Spring Boot Web模块 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- Nacos注册中心starter --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- Nacos配置中心starter --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<p>bootstrap.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># “微服务 id”-“环境名”.“文件扩展名” 三部分组合为有效的 data id，即order-service-dev.yml。data id 要和 Nacos 的设置大小写保持完全一致，这样在微服务启动时便自动会从 Nacos配置中心获取 order-service-dev.yml 配置并下载到本地完成启动过程。</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: order-service #微服务id</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev #环境名</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      config: #Nacos配置中心配置</span><br><span class="line">        file-extension: yml #文件扩展名</span><br><span class="line">        server-addr: 192.168.31.10:8848</span><br><span class="line">        username: nacos</span><br><span class="line">        password: nacos</span><br><span class="line">logging: #开启debug日志，本地使用</span><br><span class="line">  level:</span><br><span class="line">    root: debug</span><br></pre></td></tr></table></figure></li>
<li><p>controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class TestController &#123;</span><br><span class="line">    @Value(&quot;$&#123;custom.flag&#125;&quot;)</span><br><span class="line">    private String flag;</span><br><span class="line">    @Value(&quot;$&#123;custom.database&#125;&quot;)</span><br><span class="line">    private String database;</span><br><span class="line">    @GetMapping(&quot;/test&quot;)</span><br><span class="line">    public String test()&#123;</span><br><span class="line">        return &quot;flag:&quot; + flag + &quot;&lt;br/&gt; database:&quot; + database;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置中心配置</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/QL6duYOJbgrkRpw.png" alt="image-20210716064049080"></p>
<p>Data ID，Group，描述，说明，配置格式，配置内容</p>
<p>Data ID：配置的唯一标识，格式固定为：{微服务id}-{环境名}.yml，这里填写 order-service-dev.yml，其中 dev 就是环境名代表这个配置文件是 order-service 的开发环境配置文件。</p>
<p>Group：指定配置文件的分组，这里设置默认分组 DEFAULT_GROUP 即可。</p>
<p>描述：说明 order-service-dev.yml 配置文件的用途。</p>
<p>配置格式：指定“配置内容”的类型，这里选择 YAML 即可。</p>
<p>配置内容：</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/cRrm9WThZQDiFqg.png" alt="image-20210716064151924"></p>
<p>点击右下角的“发布”按钮完成设置。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/RCZQ4m7iXcJLStD.png" alt="image-20210716065250910"></p>
<p>nacos_config 数据库的 config_info 表中也出现了对应配置数据。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/5wWpve8kFYgVS39.png" alt="image-20210716065315865"></p>
</li>
<li><p>启动服务并访问接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8000/test</span><br><span class="line">结果如下：</span><br><span class="line">flag:development</span><br><span class="line">database:192.168.10.31</span><br></pre></td></tr></table></figure></li>
</ol>
<h6 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h6><p>####### 热加载</p>
<p>为了支持热加载，服务 A 的程序针对热加载需要作出如下变动：</p>
<p>第一，配置数据必须被封装到单独的配置 Bean 中；</p>
<p>第二，这个配置 Bean 需要被 @Configuration 与 @RefreshScope 两个注解描述。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Configuration // 说明这是配置Bean</span><br><span class="line">@RefreshScope // 监听，当 Nacos 推送新的配置后，由这个注解负责接收并为属性重新赋值。</span><br><span class="line">public class CustomConfig &#123;</span><br><span class="line">    @Value(&quot;$&#123;custom.flag&#125;&quot;)</span><br><span class="line">    private String flag;</span><br><span class="line">    @Value(&quot;$&#123;custom.database&#125;&quot;)</span><br><span class="line">    private String database;</span><br><span class="line">    public String getFlag() &#123;</span><br><span class="line">        return flag;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setFlag(String flag) &#123;</span><br><span class="line">        this.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getDatabase() &#123;</span><br><span class="line">        return database;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setDatabase(String database) &#123;</span><br><span class="line">        this.database = database;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class TestController &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    private CustomConfig customConfig;</span><br><span class="line">    @GetMapping(&quot;/test&quot;)</span><br><span class="line">    public String test()&#123;</span><br><span class="line">        return &quot;flag:&quot; + customConfig.getFlag() + &quot;&lt;br/&gt; database:&quot; + customConfig.getDatabase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动应用后，修改配置文件，并发布.</p>
<p>日志立即产生重新加载的信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[192.168.31.10_8848] c.a.c.n.refresh.NacosContextRefresher    : Refresh Nacos config group=DEFAULT_GROUP,dataId=order-service-dev.yml,configInfo=server:</span><br><span class="line">  port: 8000</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: order-service</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 192.168.31.10:8848</span><br><span class="line">        username: nacos</span><br><span class="line">        password: nacos</span><br><span class="line">custom: #自定义配置项</span><br><span class="line">  flag: development</span><br><span class="line">  database: 192.168.10.33</span><br><span class="line">[192.168.31.10_8848] c.a.nacos.client.config.impl.CacheData   : [fixed-192.168.31.10_8848] [notify-ok] dataId=order-service-dev.yml, group=DEFAULT_GROUP, md5=aeee8dceea709b3081d3c882ae2464b2, listener=com.alibaba.cloud.nacos.refresh.NacosContextRefresher$1@5bcff640</span><br></pre></td></tr></table></figure>



<p>####### 切换配置文件</p>
<p>在 Nacos 中设置生产环境的配置，Data Id 为 order-service-prd.yml，其中 prd 是 production 的缩写，代表生产环境配置。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/hByRiAwsb7TYZKJ.png" alt="image-20210716163910649"></p>
<p>调整 order-service 的 bootstrap.yml 引导文件，最重要的地方是修改环境名为 prd，同时更换为生产环境 Nacos 的通信地址，打包后发布。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: order-service #微服务id</span><br><span class="line">  profiles:</span><br><span class="line">    active: prd #环境名</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      config: #这里配置的是Nacos配置中心</span><br><span class="line">        file-extension: yml #指定文件扩展名</span><br><span class="line">        server-addr: 192.168.31.10:8848</span><br><span class="line">        username: nacos</span><br><span class="line">        password: nacos</span><br></pre></td></tr></table></figure>



<p>####### 管理基础配置数据</p>
<p>对比 order-service-dev.yml 与 order-service-prd.yml 发现，在不同环境的配置文件中普遍存在固定的配置项，例如：spring.application.name=order-service 配置项就是稳定的，且修改它会影响所有环境配置文件。对于这种基础的全局配置，我们可以将其存放到单独的 order-service.yml 配置中，在 order-service 服务启动时，这个不带环境名的配置文件必然会被加载。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/2XJKcliYNa4orgQ.png" alt="image-20210716164052286"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># order-service.yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: order-service</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># order-service-dev.yml</span><br><span class="line">server:</span><br><span class="line">  port: 8000</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 192.168.31.10:8848</span><br><span class="line">        username: nacos</span><br><span class="line">        password: nacos</span><br><span class="line">custom: #自定义配置项</span><br><span class="line">  flag: development</span><br><span class="line">  database: 192.168.10.33</span><br></pre></td></tr></table></figure>



<h4 id="Nacos原理"><a href="#Nacos原理" class="headerlink" title="Nacos原理"></a>Nacos原理</h4><h5 id="心跳机制与健康检查"><a href="#心跳机制与健康检查" class="headerlink" title="心跳机制与健康检查"></a>心跳机制与健康检查</h5><p>微服务与Nacos服务器通信过程：</p>
<ol>
<li><p>微服务（客户端）启动后每过5秒，会由微服务内置的 Nacos 客户端主动向 Nacos 服务器发起心跳包（HeartBeat）。心跳包会包含当前服务实例的名称、IP、端口、集群名、权重等信息。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/6sQtEHn1d2AibeK.png" alt="image-20210705065425475"></p>
</li>
<li><p>Nacos服务端收到心跳包后的处理</p>
<ol>
<li><p>首先根据 IP 与端口判断 Nacos 是否存在该服务实例？如果实例信息不存在，在 Nacos 中注册登记该实例。而注册的本质是将新实例对象存储在“实例 Map”集合中；</p>
</li>
<li><p>如果实例信息已存在，记录本次心跳包发送时间；</p>
</li>
<li><p>设置实例状态为“健康”；</p>
</li>
<li><p>推送“微服务状态变更”消息；</p>
</li>
<li><p>返回心跳包时间间隔。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/IfNkQzc7jabWJBZ.png" alt="image-20210705065743612"></p>
</li>
</ol>
</li>
<li><p>实例的不健康状态与剔除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#心跳间隔。时间单位:秒。心跳间隔</span><br><span class="line">spring.cloud.nacos.discovery.heart-beat-interval=3</span><br><span class="line"></span><br><span class="line"># Nacos Server 默认每过 15 秒对“实例 Map”中的所有实例进行扫描，服务端6秒收不到客户端心跳，会将该客户端注册的实例设为不健康</span><br><span class="line">spring.cloud.nacos.discovery.heart-beat-timeout=15</span><br><span class="line"># Nacos Server 默认每过 20 秒对“实例 Map”中的所有“非健康”实例进行扫描，如发现“非健康”实例，随即从“实例 Map”中将该实例删除。</span><br><span class="line">spring.cloud.nacos.discovery.ip-delete-timeout=30</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="热加载原理"><a href="#热加载原理" class="headerlink" title="热加载原理"></a>热加载原理</h5><p>热加载介绍：Nacos 中支持配置热加载，在运行过程中允许直接对新的配置项进行重新加载而不需要手动重启。</p>
<p>配置中心长轮询机制：</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/zO37WGxuEXsCfmi.png" alt="image-20210716070234915"></p>
<p>Nacos 服务端收到请求之后，先检查配置是否发生了变更，如果没有，则设置一个定时任务，延期 29.5s 执行，并且把当前的客户端长轮询连接加入 allSubs 队列。这时候有两种方式触发该连接结果的返回：</p>
<p>• 第一种是在等待 29.5s 后触发自动检查机制，这时候不管配置有没有发生变化，都会把结果返回客户端。而 29.5s 就是这个长连接保持的时间。</p>
<p>• 第二种是在 29.5s 内任意一个时刻，通过 Nacos Dashboard 或者 API 的方式对配置进行了修改，这会触发一个事件机制，监听到该事件的任务会遍历 allSubs 队列，找到发生变更的配置项对应的 ClientLongPolling 任务，将变更的数据通过该任务中的连接进行返回，就完成了一次“推送”操作。</p>
<p>这样既能够保证客户端实时感知配置的变化，也降低了服务端的压力。其中，这个长连接的会话超时时间默认为 30s。</p>
<h3 id="2-微服务高可用-负载均衡Ribbon"><a href="#2-微服务高可用-负载均衡Ribbon" class="headerlink" title="2.微服务高可用-负载均衡Ribbon"></a>2.微服务高可用-负载均衡Ribbon</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p><strong>负载均衡</strong>将来自客户端的请求按照某种策略平均的分配到集群的每一个节点上，保证这些节点的 CPU、内存等设备负载情况大致在一条水平线，避免由于局部节点负载过高产生宕机，再将这些处理压力传递到其他节点上产生系统性崩溃。</p>
<p><strong>分类：</strong>按实现方式可区分为服务端负载均衡与客户端负载均衡。</p>
<p><strong>服务端负载均衡：</strong>客户端先发送请求到负载均衡服务器，然后由负载均衡服务器通过负载均衡算法，在众多可用的服务器之中选择一个来处理请求。</p>
<p>服务器端负载均衡又分为两种，一种是硬件负载均衡，还有一种是软件负载均衡。</p>
<p>硬件负载均衡主要通过在服务器节点之前安装专门用于负载均衡的设备，常见的如：F5。</p>
<p>软件负载均衡则主要是在服务器上安装一些具有负载均衡功能的软件来完成请求分发进而实现负载均衡，常见的如：LVS 、 Nginx 、Haproxy。</p>
<p><strong>客户端负载均衡：</strong>客户端自己维护一个可用服务器地址列表，在发送请求前先通过负载均衡算法选择一个将用来处理本次请求的服务器，然后再直接将请求发送至该服务器。</p>
<p><strong>Ribbon负载均衡</strong>：是一个基于HTTP和TCP的客户端负载均衡器。Ribbon会到注册中心去获取服务端列表，然后进行按照负载均衡策略（如：轮询）访问以到达负载均衡的作用。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/RiTYUtd58LmXC7e.png" alt="image-20210714160800742"></p>
<p>Ribbon 执行流程：</p>
<ol>
<li>订单服务（order-service）与商品服务（goods-service）实例在启动时向 Nacos 注册；</li>
<li>订单服务向商品服务发起通信前，Ribbon 向 Nacos 查询商品服务的可用实例列表；</li>
<li>Ribbon 根据设置的负载策略从商品服务可用实例列表中选择实例；</li>
<li>订单服务实例向商品服务实例发起请求，完成 RESTful 通信；</li>
</ol>
<h4 id="Ribbon-使用"><a href="#Ribbon-使用" class="headerlink" title="Ribbon-使用"></a>Ribbon-使用</h4><h5 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h5><ol>
<li><p>提供者服务</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;spring-cloud-alibaba.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: customer-service #应用/微服务名字</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 192.168.31.102:8848 #nacos服务器地址</span><br><span class="line">        username: nacos #用户名密码</span><br><span class="line">        password: nacos</span><br><span class="line">server:</span><br><span class="line">  port: 80</span><br></pre></td></tr></table></figure></li>
<li><p>代码</p>
<p>controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">@RestController</span><br><span class="line">public class ProviderController &#123;</span><br><span class="line">    @GetMapping(&quot;/provider/msg&quot;)</span><br><span class="line">    public String sendMessage()&#123;</span><br><span class="line">        return &quot;This is the message from provider service!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>消费者服务</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;spring-cloud-alibaba.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: consumer-service #应用/微服务名字</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: localhost:8848 #nacos服务器地址</span><br><span class="line">        username: nacos #用户名密码</span><br><span class="line">        password: nacos</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    root: debug</span><br></pre></td></tr></table></figure></li>
<li><p>代码</p>
<p>启动类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class ConsumerServiceApplication &#123;</span><br><span class="line">    //Java Config声明RestTemplate对象</span><br><span class="line">    //在应用启动时自动执行restTemplate()方法创建RestTemplate对象，其BeanId为restTemplate。</span><br><span class="line">    @Bean</span><br><span class="line">    public RestTemplate restTemplate()&#123;</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ConsumerServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class ConsumerController &#123;</span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(ConsumerController.class);</span><br><span class="line">    //注入 Ribbon 负载均衡器对象</span><br><span class="line">    //在引入 starter-netflix-ribbo n后在 SpringBoot 启动时会自动实例化 LoadBalancerClient 对象。</span><br><span class="line">    //在 Controlle 使用 @Resource 注解进行注入即可。</span><br><span class="line">    @Resource</span><br><span class="line">    private LoadBalancerClient loadBalancerClient;</span><br><span class="line">    @Resource</span><br><span class="line">    //将应用启动时创建的 RestTemplate 对象注入 ConsumerController</span><br><span class="line">    private RestTemplate restTemplate;</span><br><span class="line">    @GetMapping(&quot;/consumer/msg&quot;)</span><br><span class="line">    public String getProviderMessage() &#123;</span><br><span class="line">        //loadBalancerClient.choose()方法会从 Nacos 获取 provider-service 所有可用实例，</span><br><span class="line">        //并按负载均衡策略从中选择一个可用实例，封装为 ServiceInstance（服务实例）对象</span><br><span class="line">        //结合现有环境既是从192.168.31.111:80、192.168.31.112:80、192.168.31.113:80三个实例中选择一个包装为ServiceInstance</span><br><span class="line">        ServiceInstance serviceInstance = loadBalancerClient.choose(&quot;provider-service&quot;);</span><br><span class="line">        //获取服务实例的 IP 地址</span><br><span class="line">        String host = serviceInstance.getHost();</span><br><span class="line">        //获取服务实例的端口</span><br><span class="line">        int port = serviceInstance.getPort();</span><br><span class="line">        //在日志中打印服务实例信息</span><br><span class="line">        logger.info(&quot;本次调用由provider-service的&quot; + host + &quot;:&quot; + port + &quot; 实例节点负责处理&quot; );</span><br><span class="line">        //通过 RestTemplate 对象的 getForObject() 方法向指定 URL 发送请求，并接收响应。</span><br><span class="line">        //getForObject()方法有两个参数：</span><br><span class="line">        //1. 具体发送的 URL，结合当前环境发送地址为：http://192.168.31.111:80/provider/msg</span><br><span class="line">        //2. String.class说明 URL 返回的是纯字符串，如果第二参数是实体类， RestTemplate 会自动进行反序列化，为实体属性赋值</span><br><span class="line">        String result = restTemplate.getForObject(&quot;http://&quot; + host + &quot;:&quot; + port + &quot;/provider/msg&quot;, String.class);</span><br><span class="line">        //输出响应内容</span><br><span class="line">        logger.info(&quot;provider-service 响应数据:&quot; + result);</span><br><span class="line">        //向浏览器返回响应</span><br><span class="line">        return &quot;consumer-service 响应数据:&quot; + result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>启动1个提供者，3个消费者</p>
<p>启动消费者，可以启动一个，修改端口后，再启动下一个</p>
</li>
<li><p>测试</p>
<p>默认轮询</p>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.31.120/consumer/msg%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%90%8E%E5%8F%B0%E6%97%A5%E5%BF%97">http://192.168.31.120/consumer/msg，查看后台日志</a>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">本次调用由 provider-service 的 192.168.31.111:80 实例节点负责处理</span><br><span class="line">consumer-service 获得数据:This is the message from provider service!</span><br><span class="line">本次调用由 provider-service 的 192.168.31.112:80 实例节点负责处理</span><br><span class="line">consumer-service 获得数据:This is the message from provider service!</span><br><span class="line">本次调用由 provider-service 的 192.168.31.113:80 实例节点负责处理</span><br><span class="line">consumer-service 获得数据:This is the message from provider service!</span><br><span class="line">本次调用由 provider-service 的 192.168.31.111:80 实例节点负责处理</span><br><span class="line">consumer-service 获得数据:This is the message from provider service!</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="负载均衡策略配置"><a href="#负载均衡策略配置" class="headerlink" title="负载均衡策略配置"></a>负载均衡策略配置</h5><ul>
<li>RoundRobinRule：轮询策略，Ribbon 默认策略。默认超过 10 次获取到的 server 都不可用，会返回⼀个空的 server。</li>
</ul>
<ul>
<li><p>RandomRule：随机策略，如果随机到的 server 为 null 或者不可用的话。会不停地循环选取。</p>
</li>
<li><p>RetryRule：重试策略，⼀定时限内循环重试。默认继承 RoundRobinRule，也⽀持自定义注⼊，RetryRule 会在每次选取之后，对选举的 server 进⾏判断，是否为 null，是否 alive，并且在 500ms 内会不停地选取判断。而 RoundRobinRule 失效的策略是超过 10 次，RandomRule 没有失效时间的概念，只要 serverList 没都挂。</p>
</li>
<li><p>BestAvailableRule：最小连接数策略，遍历 serverList，选取出可⽤的且连接数最小的⼀个 server。那么会调用 RoundRobinRule 重新选取。</p>
</li>
<li><p>AvailabilityFilteringRule：可用过滤策略。扩展了轮询策略，会先通过默认的轮询选取⼀个 server，再去判断该 server 是否超时可用、当前连接数是否超限，都成功再返回。</p>
</li>
<li><p>ZoneAvoidanceRule：区域权衡策略。扩展了轮询策略，除了过滤超时和链接数过多的 server，还会过滤掉不符合要求的 zone 区域⾥⾯的所有节点，始终保证在⼀个区域/机房内的服务实例进行轮询。</p>
</li>
</ul>
<h5 id="配置文件修改策略"><a href="#配置文件修改策略" class="headerlink" title="配置文件修改策略"></a>配置文件修改策略</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">provider-service: #服务提供者的微服务id</span><br><span class="line">  ribbon:</span><br><span class="line">    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule #设置对应的负载均衡类</span><br></pre></td></tr></table></figure>



<h3 id="3-服务间通信OpenFeign"><a href="#3-服务间通信OpenFeign" class="headerlink" title="3.服务间通信OpenFeign"></a>3.服务间通信OpenFeign</h3><p>OpenFeign 是Spring官方在 Netflix Feign 的基础上进行封装的技术，结合原有 Spring MVC 的注解，对 Spring Cloud 微服务通信提供了良好的支持。</p>
<p>OpenFeign 开发的方式与开发 Spring MVC Controller 颇为相似。</p>
<h4 id="OpenFeign使用"><a href="#OpenFeign使用" class="headerlink" title="OpenFeign使用"></a>OpenFeign使用</h4><p>feign使用流程：<br>    1.导包<br>    2.yml配置到eureka中<br>    3.启动类增加注解@EnableDiscoveryClient<br>    4.生产者消费者写一样的接口，者接口上写@feignclient<br>    5.生产者有订单接口的具体实现<br>    6.消费者写法同平常的controller</p>
<h5 id="demo-1"><a href="#demo-1" class="headerlink" title="demo"></a>demo</h5><ol>
<li><p>提供者服务</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: warehouse-service #应用/微服务名字</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 192.168.31.102:8848 #nacos服务器地址</span><br><span class="line">        username: nacos #用户名密码</span><br><span class="line">        password: nacos</span><br><span class="line">server:</span><br><span class="line">  port: 80</span><br></pre></td></tr></table></figure></li>
<li><p>代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class WarehouseController &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 查询对应 skuId 的库存状况</span><br><span class="line">     * @param skuId skuId</span><br><span class="line">     * @return Stock 库存对象</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/stock&quot;)</span><br><span class="line">    public Stock getStock(Long skuId)&#123;</span><br><span class="line">        Map result = new HashMap();</span><br><span class="line">        Stock stock = null;</span><br><span class="line">        if(skuId == 1101l)&#123;</span><br><span class="line">            //模拟有库存商品</span><br><span class="line">            stock = new Stock(1101l, &quot;Apple iPhone 11 128GB 紫色&quot;, 32, &quot;台&quot;);</span><br><span class="line">            stock.setDescription(&quot;Apple 11 紫色版对应商品描述&quot;);</span><br><span class="line">        &#125;else if(skuId == 1102l)&#123;</span><br><span class="line">            //模拟无库存商品</span><br><span class="line">            stock = new Stock(1101l, &quot;Apple iPhone 11 256GB 白色&quot;, 0, &quot;台&quot;);</span><br><span class="line">            stock.setDescription(&quot;Apple 11 白色版对应商品描述&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            //演示案例，暂不考虑无对应 skuId 的情况</span><br><span class="line">        &#125;</span><br><span class="line">        return stock;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>消费者服务</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.2.5.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: order-service</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 192.168.31.102:8848</span><br><span class="line">        username: nacos</span><br><span class="line">        password: nacos</span><br><span class="line">server:</span><br><span class="line">  port: 80</span><br></pre></td></tr></table></figure></li>
<li><p>代码</p>
<p>启动类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line">@SpringBootApplication</span><br><span class="line">@EnableFeignClients //启用OpenFeign</span><br><span class="line">public class OrderServiceApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(OrderServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OpenFeign通信接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line">@FeignClient(&quot;warehouse-service&quot;) //说明当前接口为 OpenFeign 通信客户端，参数值 warehouse-service 为服务提供者 ID，这一项必须与 Nacos 注册 ID 保持一致。</span><br><span class="line">public interface WarehouseServiceFeignClient &#123;</span><br><span class="line">    @GetMapping(&quot;/stock&quot;)</span><br><span class="line">    public Stock getStock(@RequestParam(&quot;skuId&quot;) Long skuId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line">import java.util.LinkedHashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">@RestController</span><br><span class="line">public class OrderController &#123;</span><br><span class="line">    //利用@Resource将IOC容器中自动实例化的实现类对象进行注入</span><br><span class="line">    @Resource</span><br><span class="line">    private WarehouseServiceFeignClient warehouseServiceFeignClient;</span><br><span class="line">    /**</span><br><span class="line">     * 创建订单业务逻辑</span><br><span class="line">     * @param skuId 商品类别编号</span><br><span class="line">     * @param salesQuantity 销售数量</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/create_order&quot;)</span><br><span class="line">    public Map createOrder(Long skuId , Long salesQuantity)&#123;</span><br><span class="line">        Map result = new LinkedHashMap();</span><br><span class="line">        //查询商品库存，像调用本地方法一样完成业务逻辑。</span><br><span class="line">        Stock stock = warehouseServiceFeignClient.getStock(skuId);</span><br><span class="line">        System.out.println(stock);</span><br><span class="line">        if(salesQuantity &lt;= stock.getQuantity())&#123;</span><br><span class="line">            //创建订单相关代码，此处省略</span><br><span class="line">            //CODE=SUCCESS代表订单创建成功</span><br><span class="line">            result.put(&quot;code&quot; , &quot;SUCCESS&quot;);</span><br><span class="line">            result.put(&quot;skuId&quot;, skuId);</span><br><span class="line">            result.put(&quot;message&quot;, &quot;订单创建成功&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            //code=NOT_ENOUGN_STOCK代表库存不足</span><br><span class="line">            result.put(&quot;code&quot;, &quot;NOT_ENOUGH_STOCK&quot;);</span><br><span class="line">            result.put(&quot;skuId&quot;, skuId);</span><br><span class="line">            result.put(&quot;message&quot;, &quot;商品库存数量不足&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h5 id="OpenFeign执行流程"><a href="#OpenFeign执行流程" class="headerlink" title="OpenFeign执行流程"></a>OpenFeign执行流程</h5><ol>
<li>第一次访问 WarehouseServiceFeignClient （OpenFeign）接口时，Spring 自动生成接口的实现类并实例化对象。</li>
<li>调用 getStock() 方法时，Ribbon 获取 warehouse-service 可用实例信息，根据负载均衡策略选择合适实例。</li>
<li>OpenFeign 根据方法上注解描述的映射关系生成完整的 URL 并发送 HTTP 请求，如果请求方法是 @PostMapping，则参数会附加在请求体中进行发送。</li>
<li>warehouse-service 处理完毕返回 JSON 数据，消费者端 OpenFeign 接收 JSON 的同时反序列化到 Stock 对象，并将该对象返回。</li>
</ol>
<h5 id="高级配置-1"><a href="#高级配置-1" class="headerlink" title="高级配置"></a>高级配置</h5><p>负载均衡+数据压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># OpenFeign负载均衡策略，默认引用Ribbon实现客户端负载均衡</span><br><span class="line">warehouse-service: #服务提供者的微服务ID</span><br><span class="line">  ribbon:</span><br><span class="line">    #设置对应的负载均衡类</span><br><span class="line">    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule</span><br><span class="line">    </span><br><span class="line"># OpenFeign 数据压缩功能</span><br><span class="line">feign:</span><br><span class="line">  compression:</span><br><span class="line">    request:</span><br><span class="line">      # 开启请求数据的压缩功能</span><br><span class="line">      enabled: true</span><br><span class="line">      # 压缩支持的MIME类型</span><br><span class="line">      mime-types: text/xml,application/xml, application/json</span><br><span class="line">      # 数据压缩下限 1024表示传输数据大于1024 才会进行数据压缩(最小压缩值标准) 压缩后尺寸只相当于原始数据的 10%~30%，通过CPU计算，极大提高带宽利用率。CPU 负载长期超过 70% 不适合开启。</span><br><span class="line">      min-request-size: 1024</span><br><span class="line">    # 开启响应数据的压缩功能</span><br><span class="line">    response:</span><br><span class="line">      enabled: true</span><br></pre></td></tr></table></figure>

<p>替换默认通信组件</p>
<p>基于 Apache HttpClient、OKHttp 组件自带的连接池，可以更好地对 HTTP 连接对象进行重用与管理。</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;feign-okhttp&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;11.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>应用入口，利用 Java Config 形式初始化 OkHttpClient 对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableFeignClients</span><br><span class="line">public class OrderServiceApplication &#123;</span><br><span class="line">    //Spring IOC容器初始化时构建okHttpClient对象</span><br><span class="line">    @Bean</span><br><span class="line">    public okhttp3.OkHttpClient okHttpClient()&#123;</span><br><span class="line">        return new okhttp3.OkHttpClient.Builder()</span><br><span class="line">                //读取超时时间</span><br><span class="line">                .readTimeout(10, TimeUnit.SECONDS)</span><br><span class="line">                //连接超时时间</span><br><span class="line">                .connectTimeout(10, TimeUnit.SECONDS)</span><br><span class="line">                //写超时时间</span><br><span class="line">                .writeTimeout(10, TimeUnit.SECONDS)</span><br><span class="line">                //设置连接池</span><br><span class="line">                .connectionPool(new ConnectionPool())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(OrderServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置启用 OKHttp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  okhttp:</span><br><span class="line">    enabled: true</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="同类产品Dubbo"><a href="#同类产品Dubbo" class="headerlink" title="同类产品Dubbo"></a>同类产品Dubbo</h4><h3 id="4-微服务大门-网关GateWay"><a href="#4-微服务大门-网关GateWay" class="headerlink" title="4.微服务大门-网关GateWay"></a>4.微服务大门-网关GateWay</h3><h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h4><h5 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h5><ul>
<li>用户身份鉴权</li>
<li>日志记录</li>
<li>黑白名单</li>
<li>反爬虫</li>
</ul>
<h5 id="网关作用"><a href="#网关作用" class="headerlink" title="网关作用"></a>网关作用</h5><ul>
<li>解耦</li>
<li>统一的一个入口，方便做统一的事。</li>
</ul>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Kou9hgpeLmkcZFC.png" alt="image-20210715142325376"></p>
<h5 id="Gateway特点"><a href="#Gateway特点" class="headerlink" title="Gateway特点"></a>Gateway特点</h5><ul>
<li><p>基于 NIO 异步处理，有更好的性能。</p>
</li>
<li><p> 配置简单</p>
</li>
<li><p>基于 JDK 8+ 开发</p>
</li>
<li><p>基于 Spring Framework 5 + Project Reactor + Spring Boot 2.0 构建</p>
</li>
<li><p>支持动态路由，能够匹配任何请求属性上的路由；</p>
</li>
<li><p>基于 HTTP 请求的路由匹配（Path、Method、Header、Host 等）</p>
</li>
<li><p>过滤器可以修改 HTTP 请求和 HTTP 响应（增加/修改 Header、增加/修改请求参数、改写请求 Path 等等）；</p>
</li>
</ul>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><h5 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h5><p>service-a提供了三个RESTFul接口</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/BgYNVWQMaxzSJrt.png" alt="image-20210715160003080"></p>
<p>service-b提供了三个接口</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/zecDQKGs8IHd64n.png" alt="image-20210715160021668"></p>
<h5 id="Gatway-demo"><a href="#Gatway-demo" class="headerlink" title="Gatway-demo"></a>Gatway-demo</h5><ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Nacos客户端 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- Spring Cloud Gateway Starter --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- 对外提供Gateway应用监控指标 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>application.yml配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: gateway #配置微服务id</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 192.168.31.101:8848 #nacos通信地址</span><br><span class="line">        username: nacos</span><br><span class="line">        password: nacos</span><br><span class="line">    gateway: #让gateway通过nacos实现自动路由转发</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true #locator.enabled 开启自动转发，根据URL规则实现默认路由转发</span><br><span class="line">server:</span><br><span class="line">  port: 80 #服务端口号</span><br><span class="line">management: </span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: &#x27;*&#x27; #对外暴露actuator所有监控指标，便于监控系统收集跟踪</span><br></pre></td></tr></table></figure></li>
<li><p>启动服务并访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 规则</span><br><span class="line">http://网关IP:端口/微服务id/URI</span><br><span class="line"></span><br><span class="line">http://192.168.31.103:80/service-a/list</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="高级配置-2"><a href="#高级配置-2" class="headerlink" title="高级配置"></a>高级配置</h5><p>路由、谓词和过滤器。</p>
<p>路由（Route）是指一个完整的网关地址映射与处理过程。（前端的请求经过网关，网关判断请求转发到）一个完整的路由包含两部分配置：谓词（Predicate）与过滤器（Filter）。前端应用发来的请求要被转发到哪个微服务上，是由谓词决定的；而转发过程中请求、响应数据被网关如何加工处理是由过滤器决定的。</p>
<h6 id="谓词"><a href="#谓词" class="headerlink" title="谓词"></a>谓词</h6><p>指定时点后路由规则生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">    - After=2020-10-04T00:00:00.000+08:00</span><br></pre></td></tr></table></figure>



<p>URI 符合映射规则时生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">    - Path=/b/**</span><br></pre></td></tr></table></figure>

<p>Header 包含指定请求头时生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">    - Header=X-Request-Id, \d+</span><br></pre></td></tr></table></figure>



<h6 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h6><p>对所有匹配的请求添加一个查询参数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filters:</span><br><span class="line">- AddRequestParameter=foo,bar #在请求参数中追加foo=bar</span><br></pre></td></tr></table></figure>

<p>返回客户端之前,添加响应数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 在Response中添加Header头，key=X-Response-Foo，Value=Bar。</span><br><span class="line"># 返回客户端之前，Header添加响应数据</span><br><span class="line">filters:</span><br><span class="line">- AddResponseHeader=X-Response,Blue</span><br></pre></td></tr></table></figure>

<p>返回 503 状态码的响应后，Retry 过滤器重新发起请求，最多重试 3 次。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">filters:</span><br><span class="line">#涉及过滤器参数时，采用name-args的完整写法</span><br><span class="line">- name: Retry #name是内置的过滤器名</span><br><span class="line">  args: #参数部分使用args说明</span><br><span class="line">    retries: 3</span><br><span class="line">    status: 503</span><br></pre></td></tr></table></figure>



<h6 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 192.168.31.10:8848</span><br><span class="line">        username: nacos</span><br><span class="line">        password: nacos</span><br><span class="line">    gateway: </span><br><span class="line">      # 网关跨域</span><br><span class="line">      globalcors:</span><br><span class="line">        cors-configurations:</span><br><span class="line">          &#x27;[/**]&#x27;:</span><br><span class="line">            # 允许携带认证信息</span><br><span class="line">            # 允许跨域的源(网站域名/ip)，设置*为全部</span><br><span class="line">            # 允许跨域请求里的head字段，设置*为全部</span><br><span class="line">            # 允许跨域的method， 默认为GET和OPTIONS，设置*为全部</span><br><span class="line">            # 跨域允许的有效期</span><br><span class="line">            allow-credentials: true</span><br><span class="line">            allowed-origins: &quot;*&quot;</span><br><span class="line">            allowed-headers: &quot;*&quot;</span><br><span class="line">            allowed-methods: &quot;*&quot;</span><br><span class="line">            max-age: 3600    </span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: false #不再需要Gateway路由转发</span><br><span class="line">      routes:  #路由规则配置</span><br><span class="line">        #第一个路由配置，service-a路由规则</span><br><span class="line">        - id: service_a_route #路由唯一标识</span><br><span class="line">          #lb开头代表基于gateway的负载均衡策略选择实例</span><br><span class="line">          uri: lb://service-a </span><br><span class="line">          #谓词配置</span><br><span class="line">          predicates:</span><br><span class="line">            #Path路径谓词，代表用户端URI如果以/a开头便会转发到service-a实例</span><br><span class="line">            - Path=/a/** </span><br><span class="line">            #After生效时间谓词，2020年10月15日后该路由才能在网关对外暴露</span><br><span class="line">            - After=2020-10-05T00:00:00.000+08:00[Asia/Shanghai]</span><br><span class="line">          #谓词配置</span><br><span class="line">          filters:</span><br><span class="line">            #忽略掉第一层前缀进行转发</span><br><span class="line">          - StripPrefix=1 </span><br><span class="line">            #为响应头附加X-Response=Blue 2020-10-15后此项为默认</span><br><span class="line">          - AddResponseHeader=X-Response,Blue </span><br><span class="line">        #第二个路由配置，service-b路由规则</span><br><span class="line">        - id: service_b_route</span><br><span class="line">          uri: lb://service-b</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/b/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">server:</span><br><span class="line">  port: 80</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: &#x27;*&#x27;</span><br></pre></td></tr></table></figure>



<p>跨域</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 全局跨域配置</span><br><span class="line"> * 注意：前端从网关进行调用时需要配置</span><br><span class="line"> * 跨域配置文件在 src/main/resources/bootstrap.yml</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@ConditionalOnBean(GlobalCorsProperties.class)</span><br><span class="line">public class GlobalCorsConfig &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private GlobalCorsProperties globalCorsProperties;</span><br><span class="line">    @Bean</span><br><span class="line">    public CorsWebFilter corsFilter() &#123;</span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource(new PathPatternParser());</span><br><span class="line">        globalCorsProperties.getCorsConfigurations().forEach((path,corsConfiguration)-&gt;source.registerCorsConfiguration(path, corsConfiguration));</span><br><span class="line">        return new CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><h5 id="路由转发流程"><a href="#路由转发流程" class="headerlink" title="路由转发流程"></a>路由转发流程</h5><p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Za3zqJMVkTHtGsN.png" alt="image-20210715160939510"></p>
<h5 id="内部执行原理"><a href="#内部执行原理" class="headerlink" title="内部执行原理"></a>内部执行原理</h5><p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/qUYIulMLEQc4Be7.png" alt="image-20210715165118189"></p>
<ol>
<li>Spring Cloud Gateway 启动时基于 Netty Server 监听指定的端口（该端口可以通过 server.port 属性自定义）。当前端应用发送一个请求到网关时，进入 Gateway Handler Mapping 处理过程，网关会根据当前 Gateway 所配置的谓词（Predicate）来决定是由哪个微服务进行处理。</li>
<li>确定微服务后，请求向后进入 Gateway Web Handler 处理过程，该过程中 Gateway 根据过滤器（Filters）配置，将请求按前后顺序依次交给 Filter 过滤链进行前置（Pre）处理，前置处理通常是对请求进行前置检查，例如：判断是否包含某个指定请求头、检查请求的 IP 来源是否合法、请求包含的参数是否正确等。</li>
<li>当过滤链前置（Pre）处理完毕后，请求会被 Gateway 转发到真正的微服务实例进行处理，微服务处理后会返回响应数据，这些响应数据会按原路径返回被 Gateway 配置的过滤链进行后置处理（Post），后置处理通常是对响应进行额外处理，例如：将处理过程写入日志、为响应附加额外的响应头或者流量监控等。</li>
</ol>
<h3 id="5-服务流量控制Sentinel"><a href="#5-服务流量控制Sentinel" class="headerlink" title="5.服务流量控制Sentinel"></a>5.服务流量控制Sentinel</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>微服务环境下受制于网络、机器性能、算法、程序各方面影响，运行异常的情况也在显著提升，加上并发量不可控，需要做好异常保护。</p>
<p>微服务雪崩：在微服务项目中指由于突发流量导致某个服务不可用，从而导致上游服务不可用，并产生级联效应，最终导致整个系统不可用。例子：服务A调⽤服务B，此时⼤量请求突然请求服务A，假如服务A本身能抗住这些请 </p>
<p>求，但是如果服务B抗不住，导致服务B请求堆积，从而服务A请求堆积，直到服务A不可用。</p>
<p>如何避免雪崩效应：</p>
<ul>
<li><p>限流</p>
<p>控制请求的流入，让流量有序的进入应用，保证流量在一个可控的范围内。</p>
</li>
<li><p>服务降级</p>
<p>当应用处理时间超过规定上限后，无论服务是否处理完成，响应返回预先设置的异常信息。</p>
</li>
<li><p>服务熔断</p>
<p>设置服务为不可用，发送心跳包，服务可用后再给该服务发请求。</p>
</li>
</ul>
<h4 id="Sentinel介绍"><a href="#Sentinel介绍" class="headerlink" title="Sentinel介绍"></a>Sentinel介绍</h4><p>Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p>
<p>特征：</p>
<ul>
<li>丰富的应用场景：承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li>
<li>完备的实时监控：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，500 台以下规模的集群的汇总运行情况。</li>
<li>广泛的开源生态：Sentinel 提供开箱即用的与其他开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 整合只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li>
<li>完善的 SPI 扩展点：Sentinel 提供简单易用、完善的 SPI 扩展接口。可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li>
</ul>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/x87jf13ZR4sUMGp.png" alt="image-20210707065815664"></p>
<h4 id="Sentinel使用"><a href="#Sentinel使用" class="headerlink" title="Sentinel使用"></a>Sentinel使用</h4><h5 id="demo-2"><a href="#demo-2" class="headerlink" title="demo"></a>demo</h5><p>Sentinel 分为两个部分：Sentinel Dashboard和Sentinel 客户端。</p>
<ol>
<li><p>Sentinel Dashboard</p>
<p>Sentinel Dashboard 是 Sentinel 配套的可视化控制台与监控仪表盘套件，它支持节点发现，以及健康情况管理、监控（单机和集群）、规则管理和推送的功能。Sentinel Dashboard 是基于 Spring Boot 开发的 WEB 应用，打包后可以直接运行。</p>
<p>Sentinel Dashboard 监听9100端口实现与微服务的通信。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/wpSfXP5nhziZxlR.png" alt="image-20210707070040503"></p>
<p>部署Sentinel Dashboard</p>
<ol>
<li><p>访问：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases%EF%BC%8C%E4%B8%8B%E8%BD%BDSentinel">https://github.com/alibaba/Sentinel/releases，下载Sentinel</a> Dashboard</p>
</li>
<li><p>启动Dashboard</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar -Dserver.port=9100 sentinel-dashboard-1.8.0.jar</span><br></pre></td></tr></table></figure></li>
<li><p>SentinelUI界面</p>
<p><a target="_blank" rel="noopener" href="http://192.168.31.10:9100/?fileGuid=xxQTRXtVcqtHK6j8">http://192.168.31.10:9100</a></p>
<p>账号&amp;密码 sentinel&amp;sentinel</p>
</li>
</ol>
</li>
<li><p>Sentinel 客户端</p>
<p>Sentinel 客户端需要集成在 Spring Boot 微服务应用中，用于接收来自 Dashboard 配置的各种规则，并通过 Spring MVC Interceptor 拦截器技术实现应用限流、熔断保护。</p>
<p>客户端配置</p>
<ol>
<li><p>创建工程，加入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Nacos客户端Starter--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- Sentinel客户端Starter--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- 对外暴露Spring Boot监控指标--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置Nacos和Sentinel</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: sentinel-sample #应用名&amp;微服务id</span><br><span class="line">  cloud:</span><br><span class="line">    sentinel: #Sentinel Dashboard通信地址</span><br><span class="line">      transport:</span><br><span class="line">        dashboard: 192.168.31.10:9100</span><br><span class="line">      eager: true #取消控制台懒加载</span><br><span class="line">    nacos: #Nacos通信地址</span><br><span class="line">      server-addr: 192.168.31.10:8848</span><br><span class="line">      username: nacos</span><br><span class="line">      password: nacos</span><br><span class="line">server:</span><br><span class="line">  port: 80</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web: #将所有可用的监控指标项对外暴露</span><br><span class="line">      exposure: #可以访问 /actuator/sentinel进行查看Sentinel监控项</span><br><span class="line">        include: &#x27;*&#x27;</span><br></pre></td></tr></table></figure></li>
<li><p>验证</p>
<p>访问Sentinel Dashboard</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/SmIK6hzpMntxucF.png" alt="image-20210707070653681"></p>
</li>
<li><p>限流demo</p>
<ol>
<li><p>Sentinel Core 写一个Controller，启动微服务</p>
</li>
<li><p>在Sentinel Dashboard配置限流规则</p>
<p>每秒钟只允许 1QPS 访问，超出的请求直接服务降级返回异常。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/me4O8Vz79xwaHu1.png" alt="image-20210709064054534"></p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/jH7dbni4Z9XAwMC.png" alt="image-20210709064208173"></p>
</li>
<li><p>验证</p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost/test_flow_rule%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8F%8D%E5%A4%8D%E5%88%B7%E6%96%B0%E3%80%82">http://localhost/test_flow_rule，浏览器反复刷新。</a></p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h5 id="Dashboard限流配置"><a href="#Dashboard限流配置" class="headerlink" title="Dashboard限流配置"></a>Dashboard限流配置</h5><p>在 Sentinel Dashboard 中“簇点链路”,找到需要限流的 URI，点击“+流控”进入流控设置。</p>
<p>Sentinel-Dashboard 加载链路使用懒加载模式，如果在簇点链路没有找到对应的 URI，需要先访问下这个功能对应的 URI </p>
<p>流控规则说明：</p>
<ul>
<li>资源名：要流控的 URI，在 Sentinel 中 URI 被称为“资源”；</li>
</ul>
<ul>
<li>针对来源：默认 default 代表所有来源，可以针对某个微服务或者调用者单独设置；</li>
</ul>
<ul>
<li>阈值类型：是按每秒访问数量（QPS）还是并发数（线程数）进行流控；</li>
</ul>
<ul>
<li><p>单机阈值：具体限流的数值是多少。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Ff2jsbUyaqguJm4.png" alt="image-20210709064702009"></p>
<p>高级选项：</p>
<ul>
<li><p>流控模式是指采用什么方式进行流量控制。</p>
<ul>
<li><p>直接模式</p>
<p>List 接口 QPS 超过 1个时限流，浏览器会出现“Blocked by Sentinel”。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/I5OrxevYB9oPqf3.png" alt="image-20210709064945827"></p>
</li>
<li><p>关联</p>
<p>同 List 接口关联的update 接口 QPS 超过 1 时，再次访问List 接口便会响应“Blocked by Sentinel”。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/dhXtnCGfoASHxFl.png" alt="image-20210709065247054"></p>
</li>
<li><p>链路</p>
<p>/check</p>
<p>​                        →   /list</p>
<p>/scan</p>
<p>两条链路都可以访问到/list</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/NDAQT59pO3SBIuo.png" alt="image-20210709065449276"></p>
<p>当访问 check 接口的QPS 超过 1 时，List 接口就会被限流。而另一条链路从 scan 接口到List 接口的链路则不会受到任何影响。</p>
</li>
</ul>
</li>
<li><p>流控效果</p>
<ul>
<li><p>快速失败</p>
<p>指流量当过限流阈值后，直接返回响应并抛出 BlockException</p>
</li>
<li><p>Warm Up（预热）</p>
<p>用于应对瞬时大并发流量冲击。当遇到突发大流量 Warm Up 会缓慢拉升阈值限制，预防系统瞬时崩溃，这期间超出阈值的访问处于队列等待状态，并不会立即抛出 BlockException。</p>
<p>List 接口平时单机阈值 QPS 处于低水位：默认为 1000/3 (冷加载因子)≈333，当瞬时大流量进来，10 秒钟内将 QPS 阈值逐渐拉升至 1000，为系统留出缓冲时间，预防突发性系统崩溃。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/rcfAFk4eyGJHN2X.png" alt="image-20210709065732758"></p>
</li>
<li><p>排队等待</p>
<p>采用匀速放行的方式对请求进行处理。如下所示，假设现在有100个请求瞬间进入，那么会出现以下几种情况：</p>
<pre><code>单机 QPS 阈值=4，代表 250 毫秒匀速放行 1 个请求，其他请求队列等待，共需 25 秒处理完毕；

单机 QPS 阈值=200，代表 5 毫秒匀速放行一个请求，其他请求队列等待，共需 0.5 秒处理完毕；

如果某一个请求在队列中处于等待状态超过 2000 毫秒，则直接抛出 BlockException。
</code></pre>
<p>匀速队列只支持 QPS 模式，且单机阈值不得大于 1000。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Fb3B6cDGIEUQ48Y.png" alt="image-20210709070050680"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Dashboard熔断配置"><a href="#Dashboard熔断配置" class="headerlink" title="Dashboard熔断配置"></a>Dashboard熔断配置</h5><h6 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h6><p>微服务的熔断是指在某个服务接口在执行过程中频繁出现故障的情况，我们便认为这种状态是“不可接受”的，立即对当前接口实施熔断。在规定的时间内，所有送达该接口的请求都将直接抛出 BlockException，在熔断期过后新的请求进入看接口是否恢复正常，恢复正常则继续运行，仍出现故障则再次熔断一段时间，以此往复直到服务接口恢复。</p>
<h6 id="熔断过程"><a href="#熔断过程" class="headerlink" title="熔断过程"></a>熔断过程</h6><p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/hkiHbjWJ2cBzn8U.png" alt="image-20210716164340305"></p>
<h6 id="熔断设置"><a href="#熔断设置" class="headerlink" title="熔断设置"></a>熔断设置</h6><p>Sentinel Dashboard可以设置三种不同的熔断模式：慢调用比例、异常比例、异常数</p>
<ul>
<li><p>慢调用比例是指当接口在1秒内“慢处理”数量超过一定比例，则触发熔断。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/ci4ITNDCKZbkBQM.png" alt="image-20210716164555605"></p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/gwBoQZT7CUGthS8.png" alt="image-20210716164729877"></p>
</li>
<li><p>异常比例是指 1 秒内按接口调用产生异常的比例（异常调用数/总数量）触发熔断。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/EBPzcNUxupmlZFf.png" alt="image-20210716164814290"></p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/azXZFPB4LtCkHSx.png" alt="image-20210716164900964"></p>
</li>
<li><p>异常数是指在 1 分钟内异常的数量超过阈值则触发熔断。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Nb7PvQVeIzUTXMB.png" alt="image-20210716164917058"></p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/TtcCsGaJpfY3dqX.png" alt="image-20210716164932771"></p>
</li>
</ul>
<h5 id="Sentinel与Nacos配置中心整合"><a href="#Sentinel与Nacos配置中心整合" class="headerlink" title="Sentinel与Nacos配置中心整合"></a>Sentinel与Nacos配置中心整合</h5><ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Nacos 客户端 Starter--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- Sentinel 客户端 Starter--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- 对外暴露 Spring Boot 监控指标--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: sentinel-sample #应用名&amp;微服务 id</span><br><span class="line">  cloud:</span><br><span class="line">    sentinel: #Sentinel Dashboard 通信地址</span><br><span class="line">      transport:</span><br><span class="line">        dashboard: 192.168.31.10:9100</span><br><span class="line">      eager: true #取消控制台懒加载</span><br><span class="line">    nacos: #Nacos 通信地址</span><br><span class="line">      server-addr: 192.168.31.10:8848</span><br><span class="line">      username: nacos</span><br><span class="line">      password: nacos</span><br><span class="line">  jackson:</span><br><span class="line">    default-property-inclusion: non_null</span><br><span class="line">server:</span><br><span class="line">  port: 80</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web: #将所有可用的监控指标项对外暴露</span><br><span class="line">      exposure: #可以访问 /actuator/sentinel进行查看Sentinel监控项</span><br><span class="line">        include: &#x27;*&#x27;</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    root: debug #开启 debug 是学习需要，生产改为 info 即可</span><br></pre></td></tr></table></figure></li>
<li><p>业务代码</p>
<p>controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class SentinelSampleController &#123;</span><br><span class="line">    //演示用的业务逻辑类</span><br><span class="line">    @Resource</span><br><span class="line">    private SampleService sampleService;</span><br><span class="line">    /**</span><br><span class="line">     * 流控测试接口</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/test_flow_rule&quot;)</span><br><span class="line">    public ResponseObject testFlowRule()&#123;</span><br><span class="line">        //code=0 代表服务器处理成功</span><br><span class="line">        return new ResponseObject(&quot;0&quot;,&quot;success!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 熔断测试接口</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/test_degrade_rule&quot;)</span><br><span class="line">    public ResponseObject testDegradeRule()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            sampleService.createOrder();</span><br><span class="line">        &#125;catch (IllegalStateException e)&#123;</span><br><span class="line">            //当 createOrder 业务处理过程中产生错误时会抛出IllegalStateException</span><br><span class="line">            //IllegalStateException 是 JAVA 内置状态异常，在项目开发时可以更换为自己项目的自定义异常</span><br><span class="line">            //出现错误后将异常封装为响应对象后JSON输出</span><br><span class="line">            return new ResponseObject(e.getClass().getSimpleName(),e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        return new ResponseObject(&quot;0&quot;,&quot;order created!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果封装类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 封装响应数据的对象</span><br><span class="line"> */</span><br><span class="line">public class ResponseObject &#123;</span><br><span class="line">    private String code; //结果编码，0-固定代表处理成功</span><br><span class="line">    private String message;//响应消息</span><br><span class="line">    private Object data;//响应附加数据（可选）</span><br><span class="line"> </span><br><span class="line">    public ResponseObject(String code, String message) &#123;</span><br><span class="line">        this.code = code;</span><br><span class="line">        this.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">    //Getter/Setter省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 演示用的业务逻辑类</span><br><span class="line"> */</span><br><span class="line">@Service</span><br><span class="line">public class SampleService &#123;</span><br><span class="line">    //模拟创建订单业务</span><br><span class="line">    public void createOrder()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //模拟处理业务逻辑需要101毫秒</span><br><span class="line">            Thread.sleep(101);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;订单已创建&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>测试</p>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost/test_flow_rule">http://localhost/test_flow_rule</a></p>
</li>
</ol>
<h6 id="整合-流控规则持久化"><a href="#整合-流控规则持久化" class="headerlink" title="整合-流控规则持久化"></a>整合-流控规则持久化</h6><ol>
<li><p>增加依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件增加配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: sentinel-sample #应用名&amp;微服务id</span><br><span class="line">  cloud:</span><br><span class="line">    sentinel: #Sentinel Dashboard通信地址</span><br><span class="line">      transport:</span><br><span class="line">        dashboard: 192.168.31.10:9100</span><br><span class="line">      eager: true #取消控制台懒加载</span><br><span class="line">      datasource:</span><br><span class="line">        flow: #数据源名称，可以自定义</span><br><span class="line">          nacos: #nacos配置中心</span><br><span class="line">            #Nacos内置配置中心，因此重用即可</span><br><span class="line">            server-addr: $&#123;spring.cloud.nacos.server-addr&#125; </span><br><span class="line">            dataId: $&#123;spring.application.name&#125;-flow-rules #定义流控规则data-id，完整名称为:sentinel-sample-flow-rules，在配置中心设置时data-id必须对应。</span><br><span class="line">            groupId: SAMPLE_GROUP #gourpId对应配置文件分组，对应配置中心groups项</span><br><span class="line">            rule-type: flow #flow固定写死，说明这个配置是流控规则</span><br><span class="line">            username: nacos #nacos通信的用户名与密码</span><br><span class="line">            password: nacos</span><br><span class="line">    nacos: #Nacos通信地址</span><br><span class="line">      server-addr: 192.168.31.10:8848</span><br><span class="line">      username: nacos</span><br><span class="line">      password: nacos</span><br></pre></td></tr></table></figure></li>
<li><p>nacos配置中添加 流控配置</p>
<p>同UI 页面配置同样的效果</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/JN1Gg5CbQ8maZov.png" alt="image-20210717222155344"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;resource&quot;:&quot;/test_flow_rule&quot;, #资源名，说明对那个URI进行流控</span><br><span class="line">        &quot;limitApp&quot;:&quot;default&quot;,  #命名空间，默认default</span><br><span class="line">        &quot;grade&quot;:1, #类型 0-线程 1-QPS</span><br><span class="line">        &quot;count&quot;:2, #超过2个QPS限流将被限流</span><br><span class="line">        &quot;strategy&quot;:0, #限流策略: 0-直接 1-关联 2-链路</span><br><span class="line">        &quot;controlBehavior&quot;:0, #控制行为: 0-快速失败 1-WarmUp 2-排队等待</span><br><span class="line">        &quot;clusterMode&quot;:false #是否集群模式</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li><p>验证流控是否生效</p>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost/test_flow_rule">http://localhost/test_flow_rule</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 服务启动时已向 Nacos 配置中心获取到流控规则。</span><br><span class="line">DEBUG 12728 --- [main] s.n.www.protocol.http.HttpURLConnection  : sun.net.www.MessageHeader@5432948015 pairs: &#123;GET /nacos/v1/cs/configs?dataId=sentinel-sample-flow-rules&amp;accessToken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTYxMDg3NTA1M30.Hq561OkXuAqPI20IBsnPIn0ia86R9sZgdWwa_K8zwvw&amp;group=SAMPLE_GROUP HTTP/1.1: null&#125;...</span><br></pre></td></tr></table></figure>

<p>在浏览器反复刷新，当 test_flow_rule 接口每秒超过 2 次访问，就会出现“Blocked by Sentinel (flow limiting)”的错误信息，说明流控规则已生效。</p>
</li>
<li><p>验证能否自动推送新规则</p>
<p>将Nacos 配置中心中流控规则 count 选项改为 1。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;resource&quot;:&quot;/test_flow_rule&quot;, </span><br><span class="line">        &quot;limitApp&quot;:&quot;default&quot;,</span><br><span class="line">        &quot;grade&quot;:1, </span><br><span class="line">        &quot;count&quot;:1, #2改为1 </span><br><span class="line">        &quot;strategy&quot;:0, </span><br><span class="line">        &quot;controlBehavior&quot;:0, </span><br><span class="line">        &quot;clusterMode&quot;:false </span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>新规则发布后，sentinel-sample控制台会立即收到下面的日志，说明新的流控规则即时生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBUG 12728 --- [.168.31.10_8848] s.n.www.protocol.http.HttpURLConnection  : sun.net.www.MessageHeader@41257f3915 pairs: &#123;GET /nacos/v1/cs/configs?dataId=sentinel-sample-flow-rules&amp;accessToken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTYxMDg3NTA1M30.Hq561OkXuAqPI20IBsnPIn0ia86R9sZgdWwa_K8zwvw&amp;group=SAMPLE_GROUP HTTP/1.1: null&#125;</span><br></pre></td></tr></table></figure>

<p>通过 Spring Boot Actuator 提供的监控指标确认流控规则已生效。</p>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost/actuator/sentinel%EF%BC%8C%E5%9C%A8">http://localhost/actuator/sentinel，在</a> flowRules 这个数组中，可以看到 test_flow_rule 的限流规则</p>
</li>
</ol>
<h5 id="自定义资源流控"><a href="#自定义资源流控" class="headerlink" title="自定义资源流控"></a>自定义资源流控</h5><p>介绍：针对某一个 Service 业务逻辑方法进行限流熔断等规则设置。</p>
<p>实例：对 SampleSerivce.createOrder方法进行熔断保护</p>
<ol>
<li><p>声明切面类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class SentinelSampleApplication &#123;</span><br><span class="line">    // 注解支持的配置Bean</span><br><span class="line">    @Bean</span><br><span class="line">    public SentinelResourceAspect sentinelResourceAspect() &#123;// 用于进行熔断的前置检查</span><br><span class="line">        return new SentinelResourceAspect();</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(SentinelSampleApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>声明资源点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 演示用的业务逻辑类</span><br><span class="line"> */</span><br><span class="line">@Service</span><br><span class="line">public class SampleService &#123;</span><br><span class="line">    //资源点名称为createOrder</span><br><span class="line">    @SentinelResource(&quot;createOrder&quot;)</span><br><span class="line">    /**</span><br><span class="line">     * 模拟创建订单业务</span><br><span class="line">     * 抛出IllegalStateException异常用于模拟业务逻辑执行失败的情况</span><br><span class="line">     */</span><br><span class="line">    public void createOrder() throws IllegalStateException&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //模拟处理业务逻辑需要101毫秒</span><br><span class="line">            Thread.sleep(101);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;订单已创建&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>启动服务测试接口，确认资源点已存在 Sentinel Dashboard</p>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost/test_degrade_rule">http://localhost/test_degrade_rule</a></p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/HVl6ZXDU7MoWrpg.png" alt="image-20210717223343479"></p>
</li>
<li><p>获取熔断规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">datasource:</span><br><span class="line">  flow: #之前的流控规则，直接忽略</span><br><span class="line">    ...</span><br><span class="line">  degrade: #熔断规则</span><br><span class="line">    nacos:</span><br><span class="line">      server-addr: $&#123;spring.cloud.nacos.server-addr&#125;</span><br><span class="line">      dataId: $&#123;spring.application.name&#125;-degrade-rules</span><br><span class="line">      groupId: SAMPLE_GROUP</span><br><span class="line">      rule-type: degrade #代表熔断</span><br><span class="line">     username: nacos</span><br><span class="line">     password: nacos</span><br></pre></td></tr></table></figure>

<p>确定配置，启动日志如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[main] s.n.www.protocol.http.HttpURLConnection  : sun.net.www.MessageHeader@d96945215 pairs: &#123;GET /nacos/v1/cs/configs?dataId=sentinel-sample-degrade-rules&amp;accessToken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTYxMDg5MDMwNH0.ooHkFb4zX14klmHMuLXTDkHSoCrwI8LtN7ex__9tMHg&amp;group=SAMPLE_GROUP HTTP/1.1: null&#125;...</span><br></pre></td></tr></table></figure></li>
<li><p>配置熔断规则</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/98314Edx7vDbYsp.png" alt="image-20210717223826845"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    &quot;resource&quot;: &quot;createOrder&quot;, #自定义资源名</span><br><span class="line">    &quot;limitApp&quot;: &quot;default&quot;, #命名空间</span><br><span class="line">    &quot;grade&quot;: 0, #0-慢调用比例 1-异常比例 2-异常数</span><br><span class="line">    &quot;count&quot;: 100, #最大RT 100毫秒执行时间</span><br><span class="line">    &quot;timeWindow&quot;: 5, #时间窗口5秒</span><br><span class="line">    &quot;minRequestAmount&quot;: 1, #最小请求数</span><br><span class="line">    &quot;slowRatioThreshold&quot;: 0.1 #比例阈值</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>熔断机制</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Z2Br69nzmhYXpx4.png" alt="image-20210717224019474"></p>
<p>访问 Spring Boot Actuator<a target="_blank" rel="noopener" href="http://localhost/actuator/sentinel%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E6%AD%A4%E6%97%B6">http://localhost/actuator/sentinel，可以看到此时</a> gradeRules 数组下 createOrder 资源点的熔断规则已被 Nacos推送并立即生效。</p>
</li>
<li><p>验证</p>
<p>连续访问 <a target="_blank" rel="noopener" href="http://localhost/test_degrade_rule%EF%BC%8C%E5%BD%93%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BF%E9%97%AE%E6%97%B6%E4%BE%BF%E4%BC%9A%E5%87%BA%E7%8E%B0">http://localhost/test_degrade_rule，当第二次访问时便会出现</a> 500 错误。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/N2kSujzBtmGxC3i.png" alt="image-20210717224132076"></p>
</li>
<li><p>完善异常提示</p>
<p>针对 RESTful 接口的统一异常处理需要实现 BlockExceptionHandler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Component //Spring IOC实例化并管理该对象</span><br><span class="line">public class UrlBlockHandler implements BlockExceptionHandler &#123;</span><br><span class="line">    /**</span><br><span class="line">     * RESTFul异常信息处理器</span><br><span class="line">     * @param httpServletRequest</span><br><span class="line">     * @param httpServletResponse</span><br><span class="line">     * @param e</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void handle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e) throws Exception &#123;</span><br><span class="line">        String msg = null;</span><br><span class="line">        if(e instanceof FlowException)&#123;//限流异常</span><br><span class="line">            msg = &quot;接口已被限流&quot;;</span><br><span class="line">        &#125;else if(e instanceof DegradeException)&#123;//熔断异常</span><br><span class="line">            msg = &quot;接口已被熔断,请稍后再试&quot;;</span><br><span class="line">        &#125;else if(e instanceof ParamFlowException)&#123; //热点参数限流</span><br><span class="line">            msg = &quot;热点参数限流&quot;; </span><br><span class="line">        &#125;else if(e instanceof SystemBlockException)&#123; //系统规则异常</span><br><span class="line">            msg = &quot;系统规则(负载/....不满足要求)&quot;;</span><br><span class="line">        &#125;else if(e instanceof AuthorityException)&#123; //授权规则异常</span><br><span class="line">            msg = &quot;授权规则不通过&quot;; </span><br><span class="line">        &#125;</span><br><span class="line">        httpServletResponse.setStatus(500);</span><br><span class="line">        httpServletResponse.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">        httpServletResponse.setContentType(&quot;application/json;charset=utf-8&quot;);</span><br><span class="line">        //ObjectMapper是内置Jackson的序列化工具类,这用于将对象转为JSON字符串</span><br><span class="line">        ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">        //某个对象属性为null时不进行序列化输出</span><br><span class="line">        mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class="line">        mapper.writeValue(httpServletResponse.getWriter(),</span><br><span class="line">                new ResponseObject(e.getClass().getSimpleName(), msg)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义资源点的异常处理</p>
<p>在 @SentinelResource 注解上额外附加 blockHandler属性进行异常处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 演示用的业务逻辑类</span><br><span class="line"> */</span><br><span class="line">@Service</span><br><span class="line">public class SampleService &#123;</span><br><span class="line">    @SentinelResource(value = &quot;createOrder&quot;,blockHandler = &quot;createOrderBlockHandler&quot;)</span><br><span class="line">    /**</span><br><span class="line">     * 模拟创建订单业务</span><br><span class="line">     * 抛出 IllegalStateException 异常用于模拟业务逻辑执行失败的情况</span><br><span class="line">     */</span><br><span class="line">    public void createOrder() throws IllegalStateException&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //模拟处理业务逻辑需要 101 毫秒</span><br><span class="line">            Thread.sleep(101);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;订单已创建&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public void createOrderBlockHandler(BlockException e) throws IllegalStateException&#123;</span><br><span class="line">        String msg = null;</span><br><span class="line">        if(e instanceof FlowException)&#123;//限流异常</span><br><span class="line">            msg = &quot;资源已被限流&quot;;</span><br><span class="line">        &#125;else if(e instanceof DegradeException)&#123;//熔断异常</span><br><span class="line">            msg = &quot;资源已被熔断,请稍后再试&quot;;</span><br><span class="line">        &#125;else if(e instanceof ParamFlowException)&#123; //热点参数限流</span><br><span class="line">            msg = &quot;热点参数限流&quot;;</span><br><span class="line">        &#125;else if(e instanceof SystemBlockException)&#123; //系统规则异常</span><br><span class="line">            msg = &quot;系统规则(负载/....不满足要求)&quot;;</span><br><span class="line">        &#125;else if(e instanceof AuthorityException)&#123; //授权规则异常</span><br><span class="line">            msg = &quot;授权规则不通过&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        throw new IllegalStateException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createOrderBlockHandler 方法的书写有两个要求</p>
<p>方法返回值、访问修饰符、抛出异常要与原始的 createOrder 方法完全相同。</p>
<p>createOrderBlockHandler 方法名允许自定义，但最后一个参数必须是 BlockException 对象，这是所有规则异常的父类，通过判断 BlockException 我们就知道触发了哪种规则异常。</p>
</li>
</ol>
<h4 id="Sentinel原理"><a href="#Sentinel原理" class="headerlink" title="Sentinel原理"></a>Sentinel原理</h4><p>Sentinel Dashboard 是Sentinel的控制端，当内置在微服务内的 Sentinel Core（客户端）接收到控制端新的限流、熔断规则后，微服务便会自动启用的相应的保护措施。</p>
<p>Sentinel执行流程：</p>
<ol>
<li>Sentinel Core与Sentinel Dashboard建立连接</li>
<li>Sentinel Dashboard 向Sentinel Core下发新的保护规则</li>
<li>Sentinel Core应用新的保护规则，实施限流、熔断等。</li>
</ol>
<p>Sentinel执行流程细节：</p>
<ol>
<li><p>建立连接</p>
<p>Sentinel core 初始化时，主动向application.yml中配置的Dashboard的IP地址发起连接请求。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#Sentinel Dashboard通信地址</span><br><span class="line">spring: </span><br><span class="line">  cloud:</span><br><span class="line">    sentinel: </span><br><span class="line">      transport:</span><br><span class="line">        dashboard: 192.168.31.10:9100</span><br></pre></td></tr></table></figure>

<p>该请求以心跳包的方式定时向Dashboard发送，包含Sentinel Core 的AppName、IP、端口信息。</p>
<p>Sentinel Core持续接收Dashboard数据和发送心跳包使用8719 端口。</p>
<p>Sentinel Dashboard 接收到心跳包后，来自 Sentinel Core的AppName、IP、端口信息会被封装为 MachineInfo 对象放入 ConcurrentHashMap 保存在 JVM的内存中，以备后续使用。</p>
</li>
<li><p>Dashboard下发保护规则</p>
<ol>
<li>Dashboard 页面中设置了新的保护规则，</li>
<li>从当前的 MachineInfo 中提取符合要求的微服务实例信息</li>
<li>通过 Dashboard内置的 transport 模块将新规则打包推送到微服务实例的 Sentinel Core</li>
</ol>
</li>
<li><p>Sentinel Core应用新规则</p>
<ol>
<li><p>Sentinel Core收 到新规则</p>
</li>
<li><p>对本地规则进行更新。</p>
</li>
<li><p>依据规则处理请求。</p>
<p>Sentinel Core 为服务限流、熔断提供了核心拦截器 SentinelWebInterceptor，这个拦截器默认对所有请求 /** 进行拦截，然后开始请求的链式处理流程，在对于每一个处理请求的节点被称为 Slot（槽），通过多个槽的连接形成处理链，在请求的流转过程中，如果有任何一个 Slot 验证未通过，都会产生 BlockException，请求处理链便会中断，并返回“Blocked by sentinel” 异常信息。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/WsMCDPGHZa3xVER.png" alt="image-20210708211817988"></p>
<p>默认 Slot 有7 个，前 3 个 Slot为前置处理，用于收集、统计、分析必要的数据；后 4 个为规则校验 Slot，从Dashboard  推送的新规则保存在“规则池”中，然后对应 Slot 进行读取并校验当前请求是否允许放行，允许放行则送入下一个 Slot 直到最终被  RestController 进行业务处理，不允许放行则直接抛出 BlockException 返回响应。</p>
<p>Slot具体职责：</p>
<ul>
<li>NodeSelectorSlot 负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级；</li>
<li>ClusterBuilderSlot 则用于存储资源的统计信息以及调用者信息，例如该资源的 RT（运行时间）, QPS, thread count（线程总数）等，这些信息将用作为多维度限流，降级的依据；</li>
<li>StatistcSlot 则用于记录，统计不同维度的runtime 信息；</li>
<li>SystemSlot 则通过系统的状态，例如CPU、内存的情况，来控制总的入口流量；</li>
<li>AuthoritySlot 则根据黑白名单，来做黑白名单控制；</li>
<li>FlowSlot 则用于根据预设的限流规则，以及前面 slot 统计的状态，来进行限流；</li>
<li>DegradeSlot 则通过统计信息，以及预设的规则，来做熔断降级。</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 id="6-应用性能监控SkyWalking"><a href="#6-应用性能监控SkyWalking" class="headerlink" title="6.应用性能监控SkyWalking"></a>6.应用性能监控SkyWalking</h3><p>博客地址 TODO</p>
<h4 id="Sleuth-Zipkin"><a href="#Sleuth-Zipkin" class="headerlink" title="Sleuth+Zipkin"></a>Sleuth+Zipkin</h4><h5 id="使用-Tracer-在访问链路中创建自定义的-Span"><a href="#使用-Tracer-在访问链路中创建自定义的-Span" class="headerlink" title="使用 Tracer 在访问链路中创建自定义的 Span"></a>使用 Tracer 在访问链路中创建自定义的 Span</h5><p>介绍：创建自定义的 Span 并纳入可视化监控机制中</p>
<p>场景：在业务系统中重点监控某些业务操作</p>
<p>版本1.X </p>
<p>实现：通过 Spring Cloud Sleuth 自带的 org.springframework.cloud.sleuth.Tracer 接口创建和管理自定义 Span。</p>
<p>版本：2.X </p>
<p>实现：使用 Brave 创建自定义 Span</p>
<p>代码：</p>
<ol>
<li><p>业务中添加代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class MyService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private Tracer tracer;// </span><br><span class="line"></span><br><span class="line">    public void perform() &#123;</span><br><span class="line">    	// 创建并启动了一个“spanName”新的 Span</span><br><span class="line">         Span newSpan = tracer.nextSpan().name(&quot;spanName&quot;).start();</span><br><span class="line">        //ScopedSpan newSpan = tracer.startScopedSpan(&quot;spanName&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            //执行业务逻辑</span><br><span class="line">        &#125;</span><br><span class="line">        finally&#123;</span><br><span class="line">          newSpan.tag(&quot;key&quot;, &quot;value&quot;);</span><br><span class="line">          newSpan.annotate(&quot;myannotation&quot;);</span><br><span class="line">          newSpan.finish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>注解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@NewSpan(name = &quot;myspan&quot;)//创建新span</span><br><span class="line">void myMethod(@SpanTag(&quot;mykey&quot;) String param);//生成一个键为“mykey”，值为 param 的新标签。</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="7-分布式事务Seata"><a href="#7-分布式事务Seata" class="headerlink" title="7.分布式事务Seata"></a>7.分布式事务Seata</h3><h4 id="介绍-4"><a href="#介绍-4" class="headerlink" title="介绍"></a>介绍</h4><h5 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h5><ol>
<li><p>跨数据库操作</p>
</li>
<li><p>跨系统的分布式事务</p>
<p>与第三方系统（企业内外）集成可能遇到</p>
</li>
<li><p>跨服务的分布式事务</p>
</li>
<li><p>跨数据库与消息的分布式事务</p>
</li>
</ol>
<h5 id="分布式解决方案"><a href="#分布式解决方案" class="headerlink" title="分布式解决方案"></a>分布式解决方案</h5><p>分布式事务解决方案：二阶段提交（2PC）与三阶段提交（3PC）。</p>
<h6 id="三阶段提交"><a href="#三阶段提交" class="headerlink" title="三阶段提交"></a>三阶段提交</h6><p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/rENSnD2kHyp7UYQ.png" alt="image-20210716171516747"></p>
<ol>
<li><p>阶段一，事务预处理阶段。</p>
<p>事务协调者会向各服务下达“处理本地事务”的通知，本地事务开始处理业务逻辑，如订单服务中负责创建新的订单记录；会员服务负责增加会员的积分；库存服务负责减少库存数量。被操作的所有数据都处于未提交（uncommit）的状态，会被排它锁锁定。本地事务都处理完成后，会通知事务协调者“本地事务处理完毕”。所有本地事务处理完毕后，进入阶段二。</p>
</li>
<li><p>阶段二，预提交阶段。</p>
<p>预提交阶段只是一个询问机制，以确认所有服务都已准备好，同时在此阶段协调者和参与者都设置了超时时间以防止出现长时间资源锁定。当阶段二所有服务返回“可以提交”，进入阶段三“提交阶段”。</p>
</li>
<li><p>阶段三，提交阶段</p>
<p>3PC 的提交阶段与 2PC 的提交阶段是一致的，在每一个数据库中执行提交实现数据的资源写入，如果协调者与服务通信中断导致无法提交，在服务端超时后在也会自动执行提交操作来保证资源释放。</p>
</li>
</ol>
<p>问题：预提交阶段引入了超时机制，让数据库资源不会被长期锁定，数据一致性也很可能因为超时后的强制提交被破坏。</p>
<p>解决：增加异步的数据补偿任务、日终跑批前的数据补偿、更完善的业务数据完整性的校验代码、引入数据监控及时通知人工补录。</p>
<h5 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h5><p>AT：需要数据库支持事务，使用简单。（自动解析sql生成反向SQL，用于回滚。）</p>
<p>TCC：开启、提交、回滚程序员控制，灵活，复杂（失败时，事务自动多次提交，还需考虑幂等性）</p>
<h4 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h4><p>AT 模式</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/XdT9whlAurJ5H7q.png" alt="image-20210717093558206"></p>
<h5 id="部署TC-Seata-Server"><a href="#部署TC-Seata-Server" class="headerlink" title="部署TC-Seata-Server"></a>部署TC-Seata-Server</h5><ol>
<li><p>下载seata</p>
<p><a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases/download/v1.4.0/seata-server-1.4.0.tar.gz">https://github.com/seata/seata/releases/download/v1.4.0/seata-server-1.4.0.tar.gz</a></p>
</li>
<li><p>配置seata接入注册中心和配置中心， conf/registry.conf 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  # Seata-Server支持以下几种注册中心，这里改为nacos，默认是file文件形式不介入任何注册中心。</span><br><span class="line">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line">  # 负载均衡采用随机策略</span><br><span class="line">  loadBalance = &quot;RandomLoadBalance&quot;</span><br><span class="line">  loadBalanceVirtualNodes = 10</span><br><span class="line">  # nacos注册中心接入配置</span><br><span class="line">  nacos &#123;</span><br><span class="line">    # 应用名称</span><br><span class="line">    application = &quot;seata-server&quot;</span><br><span class="line">    #IP地址与端口</span><br><span class="line">    serverAddr = &quot;192.168.31.10:8848&quot;</span><br><span class="line">    # 分配应用组，采用默认值SEATA_GROUP即可</span><br><span class="line">    group = &quot;SEATA_GROUP&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    # 集群名称，采用默认值default即可</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    # Nacos接入用户名密码</span><br><span class="line">    username = &quot;nacos&quot;</span><br><span class="line">    password = &quot;nacos&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#Seata-Server接入配置中心</span><br><span class="line">config &#123;</span><br><span class="line">  # Seata-Server支持以下配置中心产品，这里设置为nacos，默认是file即文件形式保存配置内容。</span><br><span class="line">  # file、nacos 、apollo、zk、consul、etcd3</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line">  # 设置Nacos的通信地址</span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;192.168.31.10:8848&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    group = &quot;SEATA_GROUP&quot;</span><br><span class="line">    username = &quot;nacos&quot;</span><br><span class="line">    password = &quot;nacos&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>nacos配置中心初始化seata配置</p>
<p>官网找初始化脚本<a target="_blank" rel="noopener" href="https://github.com/seata/seata/blob/1.4.0/script/config-center/config.txt">https://github.com/seata/seata/blob/1.4.0/script/config-center/config.txt</a></p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/2pLJDeRSGi4NWKg.png" alt="image-20210717093755192"></p>
<p>在 /usr/local/seata-server-1.4.0 目录创建 config.txt文件，复制脚本内容到文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 修改</span><br><span class="line">store.db.url=jdbc:mysql://192.168.31.103:3309/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span><br><span class="line">store.db.user=root</span><br><span class="line">store.db.password=root</span><br></pre></td></tr></table></figure>

<p>下载运行脚本</p>
<p><a target="_blank" rel="noopener" href="https://github.com/seata/seata/blob/1.4.0/script/config-center/nacos/nacos-config.sh">https://github.com/seata/seata/blob/1.4.0/script/config-center/nacos/nacos-config.sh</a></p>
<p>在 /usr/local/seata-server-1.4.0 目录创建 script 子目录。放入文件</p>
<p>运行导入脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh nacos-config.sh -h 192.168.31.10</span><br></pre></td></tr></table></figure>

<p>Nacos 后台<a target="_blank" rel="noopener" href="http://192.168.31.10:8848/nacos">http://192.168.31.10:8848/nacos</a> ，会看到大量 SEATA_GROUP 分组的配置，Seata-Server 启动时自动读取</p>
</li>
<li><p>创建并初始化Seata-Server全局事务数据库</p>
<p>下载 SQL 脚本 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/blob/1.4.0/script/server/db/mysql.sql">https://github.com/seata/seata/blob/1.4.0/script/server/db/mysql.sql</a></p>
<p>MySQL中创建数据库 seata，执行SQL脚本创建全局事务表</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/Z3HPVsqb5EUteAR.png" alt="image-20210717094319951"></p>
</li>
<li><p>启动 seata-server</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/seata-server.sh</span><br></pre></td></tr></table></figure>

<p>启动过程中提示数据库无法访问，说明 IP、端口配置有问题，可以通过 Nacos 配置中心设置 store.db.url 选项，而不是重新导入 config.txt。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/qkNpvbTioxBKyPE.png" alt="image-20210717094506894"></p>
</li>
</ol>
<h5 id="开发RM资源管理器"><a href="#开发RM资源管理器" class="headerlink" title="开发RM资源管理器"></a>开发RM资源管理器</h5><p>订单服务、会员服务、库存服务</p>
<h6 id="订单服务"><a href="#订单服务" class="headerlink" title="订单服务"></a>订单服务</h6><ol>
<li><p>创建seata-order数据库和 undo_log 表。Seata 强制要求在每个 RM 端数据库创建的表，用于存储反向 SQL 的元数据</p>
<p><a target="_blank" rel="noopener" href="https://github.com/seata/seata/blob/1.4.0/script/client/at/db/mysql.sql">https://github.com/seata/seata/blob/1.4.0/script/client/at/db/mysql.sql</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 订单业务表 order</span><br><span class="line">SET NAMES utf8mb4;</span><br><span class="line">SET FOREIGN_KEY_CHECKS = 0;</span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for order</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS `order`;</span><br><span class="line">CREATE TABLE `order`  (</span><br><span class="line">  `order_id` int(255) NOT NULL AUTO_INCREMENT COMMENT &#x27;订单编号&#x27;,</span><br><span class="line">  `goods_id` int(32) NOT NULL COMMENT &#x27;商品编号&#x27;,</span><br><span class="line">  `member_id` int(32) NOT NULL COMMENT &#x27;会员编号&#x27;,</span><br><span class="line">  `quantity` int(255) NOT NULL COMMENT &#x27;购买数量&#x27;,</span><br><span class="line">  `points` int(255) NOT NULL COMMENT &#x27;增加会员积分&#x27;,</span><br><span class="line">  PRIMARY KEY (`order_id`) USING BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = 51 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;</span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for undo_log</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS `undo_log`;</span><br><span class="line">CREATE TABLE `undo_log`  (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `branch_id` bigint(20) NOT NULL,</span><br><span class="line">  `xid` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,</span><br><span class="line">  `context` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,</span><br><span class="line">  `rollback_info` longblob NOT NULL,</span><br><span class="line">  `log_status` int(11) NOT NULL,</span><br><span class="line">  `log_created` datetime(0) NOT NULL,</span><br><span class="line">  `log_modified` datetime(0) NOT NULL,</span><br><span class="line">  `ext` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE,</span><br><span class="line">  UNIQUE INDEX `ux_undo_log`(`xid`, `branch_id`) USING BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = 5 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;</span><br><span class="line">SET FOREIGN_KEY_CHECKS = 1;</span><br></pre></td></tr></table></figure></li>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--Spring Boot JPA--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--Web MVC--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--Nacos客户端--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--seata--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;seata-all&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--seata 客户端最新版--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;seata-all&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--seata与spring boot starter--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--JDBC驱动--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#seata配置</span><br><span class="line">seata:</span><br><span class="line">#  开启seata分布式事务</span><br><span class="line">  enabled: true</span><br><span class="line">#  事务服务分组名,与naocs一致</span><br><span class="line">  tx-service-group: my_test_tx_group</span><br><span class="line">#  是否启用数据源代理</span><br><span class="line">  enable-auto-data-source-proxy: true</span><br><span class="line">#  事务服务配置</span><br><span class="line">  service:</span><br><span class="line">    vgroup-mapping:</span><br><span class="line">#      事务分组对应集群名称</span><br><span class="line">      my_test_tx_group: default</span><br><span class="line">    grouplist:</span><br><span class="line">#      Seata-Server服务的IP地址与端口</span><br><span class="line">      default: 192.168.31.107:8091</span><br><span class="line">    enable-degrade: false</span><br><span class="line">    disable-global-transaction: false</span><br><span class="line">#    Nacos配置中心信息</span><br><span class="line">  config:</span><br><span class="line">    type: nacos</span><br><span class="line">    nacos:</span><br><span class="line">      namespace:</span><br><span class="line">      serverAddr: 192.168.31.10:8848</span><br><span class="line">      group: SEATA_GROUP</span><br><span class="line">      username: nacos</span><br><span class="line">      password: nacos</span><br><span class="line">      cluster: default</span><br><span class="line">#      Nacos注册中心信息</span><br><span class="line">  registry:</span><br><span class="line">    type: nacos</span><br><span class="line">    nacos:</span><br><span class="line">      application: seata-server</span><br><span class="line">      server-addr: 192.168.31.10:8848</span><br><span class="line">      group : SEATA_GROUP</span><br><span class="line">      namespace:</span><br><span class="line">      username: nacos</span><br><span class="line">      password: nacos</span><br><span class="line">      cluster: default</span><br><span class="line"># 应用配置</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: rm-order</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://192.168.31.103:3306/seata-order</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        username: nacos</span><br><span class="line">        password: nacos</span><br><span class="line">        server-addr: 192.168.31.10:8848</span><br><span class="line">  jpa:</span><br><span class="line">    show-sql: true</span><br><span class="line">server:</span><br><span class="line">  port: 8002</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    io:</span><br><span class="line">      seata: debug</span><br></pre></td></tr></table></figure></li>
<li><p>开发crud</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//JPA实体类</span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;`order`&quot;) //对应order表</span><br><span class="line">public class Order &#123;</span><br><span class="line">    @Id</span><br><span class="line">    @Column(name = &quot;order_id&quot;)</span><br><span class="line">    private Integer id; //订单编号</span><br><span class="line">    private Integer memberId; //会员编号</span><br><span class="line">    @Column(name = &quot;goods_id&quot;)</span><br><span class="line">    private Integer goodsId; //商品编号</span><br><span class="line">    private Integer points; //新增积分</span><br><span class="line">    private Integer quantity; //销售数量</span><br><span class="line">    public Order() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public Order(Integer id, Integer memberId, Integer goodsId, Integer points, Integer quantity) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">        this.memberId = memberId;</span><br><span class="line">        this.points = points;</span><br><span class="line">        this.goodsId = goodsId;</span><br><span class="line">        this.quantity = quantity;</span><br><span class="line">    &#125;</span><br><span class="line">    //...getter &amp; setter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public interface OrderRepository extends JpaRepository&lt;Order,Integer&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class OrderService &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    private OrderRepository orderRepository;</span><br><span class="line">    @Transactional</span><br><span class="line">    public Order createOrder(Integer orderId,Integer memberId,Integer goodsId,Integer points,Integer quantity)&#123;</span><br><span class="line">        return orderRepository.save(new Order(orderId, memberId,goodsId,points,quantity));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class OrderController &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    private OrderService orderService;</span><br><span class="line">    @GetMapping(&quot;/create_order&quot;)</span><br><span class="line">    public String createOrder(Integer orderId,Integer memberId,Integer goodsId,Integer points,Integer quantity) throws JsonProcessingException &#123;</span><br><span class="line">        Map result = new HashMap&lt;&gt;();</span><br><span class="line">        Order order = orderService.createOrder(orderId,memberId,goodsId,points,quantity);</span><br><span class="line">        result.put(&quot;code&quot;, &quot;0&quot;);</span><br><span class="line">        result.put(&quot;message&quot;, &quot;create order success&quot;);</span><br><span class="line">        return new ObjectMapper().writeValueAsString(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置 DataSourceProxy 数据源代理类，用于seata自动生成 undo_log 回滚数据，以及自动完成 RM 端分布式事务的提交或回滚操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line">import io.seata.rm.datasource.DataSourceProxy;</span><br><span class="line">import org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Primary;</span><br><span class="line">@Configuration</span><br><span class="line">public class DataSourceProxyConfig &#123;</span><br><span class="line">    //创建Druid数据源</span><br><span class="line">    @Bean</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br><span class="line">    public DruidDataSource druidDataSource() &#123;</span><br><span class="line">        return new DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">    //建立DataSource数据源代理</span><br><span class="line">    @Primary</span><br><span class="line">    @Bean</span><br><span class="line">    public DataSourceProxy dataSource(DruidDataSource druidDataSource) &#123;</span><br><span class="line">        return new DataSourceProxy(druidDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>启动 rm-order，访问 create_order 接口</p>
<p><a target="_blank" rel="noopener" href="http://192.168.31.106:8002/create_order?orderId=6&amp;memberId=1&amp;goodsId=2&amp;points=20&amp;quantity=200">http://192.168.31.106:8002/create_order?orderId=6&amp;memberId=1&amp;goodsId=2&amp;points=20&amp;quantity=200</a></p>
</li>
</ol>
<h6 id="rm-points-积分服务"><a href="#rm-points-积分服务" class="headerlink" title="rm-points 积分服务"></a>rm-points 积分服务</h6><h6 id="rm-storage-库存服务"><a href="#rm-storage-库存服务" class="headerlink" title="rm-storage 库存服务"></a>rm-storage 库存服务</h6><h5 id="开发TM-事务管理器"><a href="#开发TM-事务管理器" class="headerlink" title="开发TM 事务管理器"></a>开发TM 事务管理器</h5><ol>
<li><p>创建 seata-mall 数据库和undo_log 表</p>
</li>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;seata-all&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;seata-all&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;spring-cloud-alibaba.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#seata配置与rm-order完全相同，省略</span><br><span class="line">seata:</span><br><span class="line">...</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: tm-mall</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://192.168.31.103:3305/seata-mall</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br><span class="line">...</span><br><span class="line">server:</span><br><span class="line">  port: 8001</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li><p>启动类增加远程调用注解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableFeignClients</span><br><span class="line">public class TmMallApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(TmMallApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>开发三个远程调用接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//订单服务客户端</span><br><span class="line">@FeignClient(&quot;rm-order&quot;)</span><br><span class="line">public interface OrderFeignClient &#123;</span><br><span class="line">    @GetMapping(&quot;/create_order&quot;)</span><br><span class="line">    public String createOrder(@RequestParam(&quot;orderId&quot;) Integer orderId,</span><br><span class="line">                              @RequestParam(&quot;memberId&quot;) Integer memberId,</span><br><span class="line">                              @RequestParam(&quot;goodsId&quot;) Integer goodsId,</span><br><span class="line">                              @RequestParam(&quot;points&quot;) Integer points,</span><br><span class="line">                              @RequestParam(&quot;quantity&quot;) Integer quantity</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//积分服务客户端</span><br><span class="line">@FeignClient(&quot;rm-points&quot;)</span><br><span class="line">public interface PointsFeignClient &#123;</span><br><span class="line">    @GetMapping(&quot;/add_points&quot;)</span><br><span class="line">    public String addPoints(@RequestParam(&quot;memberId&quot;) Integer memberId, @RequestParam(&quot;points&quot;) Integer points);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//库存服务客户端</span><br><span class="line">@FeignClient(&quot;rm-storage&quot;)</span><br><span class="line">public interface StorageFeignClient &#123;</span><br><span class="line">    @GetMapping(&quot;/reduce_storage&quot;)</span><br><span class="line">    public String reduceStorage(@RequestParam(&quot;goodsId&quot;) Integer goodsId, @RequestParam(&quot;quantity&quot;) Integer quantity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>开发 MallService，定义全局事务范围。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class MallService &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    OrderFeignClient orderFeignClient;</span><br><span class="line">    @Resource</span><br><span class="line">    PointsFeignClient pointsFeignClient;</span><br><span class="line">    @Resource</span><br><span class="line">    StorageFeignClient storageFeignClient;</span><br><span class="line"></span><br><span class="line">    @GlobalTransactional(name = &quot;seata-group-tx-mall&quot;, rollbackFor = &#123;Exception.class&#125;) // 全局事务注解,MallService.sale 方法时通知 TC 开启全局事务，sale 方法执行成功自动通知 TC 进行全局提交；sale 方法抛出异常时自动通知 TC 进行全局回滚。</span><br><span class="line">    public String sale(Integer orderId,Integer memberId,Integer goodsId,Integer points,Integer quantity) &#123;</span><br><span class="line">        String orderResult = orderFeignClient.createOrder(orderId,memberId,goodsId,points,quantity);</span><br><span class="line">        String pointsResult = pointsFeignClient.addPoints(memberId, points);</span><br><span class="line">        String storageResult = storageFeignClient.reduceStorage(goodsId, quantity);</span><br><span class="line">        return orderResult + &quot; / &quot; + pointsResult + &quot; / &quot; + storageResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>开发 MallController 对外暴露 sale 接口提供调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class MallController &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    private MallService mallService;</span><br><span class="line">    @GetMapping(&quot;/sale&quot;)</span><br><span class="line">    public String sale(Integer orderId,Integer memberId,Integer goodsId,Integer points,Integer quantity)&#123;</span><br><span class="line">        return mallService.sale(orderId,memberId,goodsId,points,quantity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置 DataSourceProxyConfig，这是所有 TM 与 RM 都要设置的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class DataSourceProxyConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br><span class="line">    public DruidDataSource druidDataSource() &#123;</span><br><span class="line">        return new DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">    @Primary</span><br><span class="line">    @Bean</span><br><span class="line">    public DataSourceProxy dataSource(DruidDataSource druidDataSource) &#123;</span><br><span class="line">        return new DataSourceProxy(druidDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><p>启动 Nacos、TC、TM、3 个 RM ，</p>
<ul>
<li><p>正常验证</p>
<p>访问 tm-mall 的 sale 接口。</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8001/sale?orderId=6&amp;memberId=1&amp;goodsId=2&amp;points=20&amp;quantity=20">http://localhost:8001/sale?orderId=6&amp;memberId=1&amp;goodsId=2&amp;points=20&amp;quantity=20</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">## TM端日志</span><br><span class="line"># 启动全局事务</span><br><span class="line">i.seata.tm.api.DefaultGlobalTransaction  : Begin new global transaction [192.168.31.107:8091:100622589646344192]</span><br><span class="line">...</span><br><span class="line"># 全局事务已提交</span><br><span class="line">i.seata.tm.api.DefaultGlobalTransaction  : [192.168.31.107:8091:100622589646344192] commit status: Committed</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## RM日志</span><br><span class="line"># 分支事务已提交</span><br><span class="line">i.s.c.r.p.c.RmBranchCommitProcessor      : branch commit result:xid=192.168.31.107:8091:100622589646344192,branchId=100622590170632192,branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null</span><br><span class="line"># 清空undo_log表</span><br><span class="line">i.s.r.d.undo.mysql.MySQLUndoLogManager   : batch delete undo log size 1</span><br></pre></td></tr></table></figure></li>
<li><p>异常验证</p>
<p>quantity 设置为 200，超出库存报错，看能否全局回滚。<br><a target="_blank" rel="noopener" href="http://localhost:8001/sale?orderId=6&amp;memberId=1&amp;goodsId=2&amp;points=20&amp;quantity=200">http://localhost:8001/sale?orderId=6&amp;memberId=1&amp;goodsId=2&amp;points=20&amp;quantity=200</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 程序报错</span><br><span class="line">java.lang.IllegalStateException: 商品库存不足。</span><br><span class="line"></span><br><span class="line">// TM 向 TC 发起全局回滚通知。</span><br><span class="line">i.seata.tm.api.DefaultGlobalTransaction  : Begin new global transaction [192.168.31.107:8091:100626590567763968]</span><br><span class="line">i.s.c.rpc.netty.AbstractNettyRemoting    : io.seata.core.rpc.netty.TmNettyRemotingClient@2e81af7d msgId:1726, body:globalStatus=Rollbacked,ResultCode=Success,Msg=null</span><br></pre></td></tr></table></figure>

<p>TC 向 RM 下达分支事务回滚通知，RM 收到通知做两件事：第一，根据 undo_log 表生成的反向 SQL，将之前写入的数据撤销；第二，删除 undo_log 数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">i.s.r.d.undo.AbstractUndoLogManager      : Flushing UNDO LOG: &#123;&quot;@class&quot;:&quot;io.seata.rm.datasource.undo.BranchUndoLog&quot;,&quot;xid&quot;:&quot;192.168.31.107:8091:100626590567763968&quot;,&quot;branchId&quot;:100626590894919681...</span><br><span class="line">io.seata.rm.AbstractRMHandler            : Branch Rollbacking: 192.168.31.107:8091:100626590567763968 100626590894919681 jdbc:mysql://192.168.31.103:3306/seata-order</span><br><span class="line">i.s.r.d.undo.AbstractUndoLogManager      : xid 192.168.31.107:8091:100626590567763968 branch 100626590894919681, undo_log deleted with GlobalFinished</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><h4 id="失效"><a href="#失效" class="headerlink" title="失效"></a>失效</h4><p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/4843e7f2f94bb2d2f2a19fc973a5f21.jpg"></p>
<h3 id="8-分布式锁"><a href="#8-分布式锁" class="headerlink" title="8.分布式锁"></a>8.分布式锁</h3><p>用途：控制分布式系统中的不同主机之间对共享资源的访问。</p>
<ul>
<li>同一应用程序多实例下控制只有一个实例执行。</li>
<li>不同应用程序只有一个程序修改数据。</li>
</ul>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li>定时拉取上游系统数据，部署了双节点。不用分布式锁，定时任务会执行两次。</li>
<li>防止同一用户对同一接口短时间多次点击。</li>
<li>秒杀系统的库存管理，避免超卖。</li>
</ul>
<h4 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h4><ul>
<li><p>zookeeper</p>
<p>介绍：利⽤的是zookeeper的临时节点、顺序节点、watch机制来实现的，zookeeper分布式 锁的特点是⾼⼀致性，因为zookeeper保证的是CP，所以由它实现的分布式锁更可靠，不会出现混乱。先同步到一半以上从节点，再返回加锁成功；</p>
<p>流程：客户端要获取锁，1.在请求下创建临时顺序子节点，2.若节点最小，则获得了锁，执行业务3.使用完锁，则删除该节点，释放锁。</p>
<p>详细流程：</p>
<ol>
<li>客户端在lock节点下创建临时顺序节点。</li>
<li>2.获取lock下面的所有子节点，如果发现自己创建的子节点序号最小，那么就认为该客户端获取到了锁，执行业务代码。使用完锁后，将该节点删除。</li>
<li>3.如果自己创建的节点并非lock所有子节点中最小的，找到比自己小的那个节点，同时对其注册事件监听器，监听删除事件。</li>
<li>4.如果发现比自己小的那个节点被删除，则客户端的Watcher会收到相应通知，此时再次判断自己创建的节点是否是lock子节点中序号最小的，如果是则获取到了锁，如果不是则重复以上步骤（监听比自己小一个节点的删除事件，判断自己是否是最小节点）。</li>
</ol>
</li>
<li><p>redis</p>
<p>介绍：利⽤redis的setnx、lua脚本、消费订阅等机制来实现的，redis分布式锁的特点是⾼可⽤， 因为redis保证的是AP，所以由它实现的分布式锁可能不可靠，不稳定（⼀旦redis中的数据出现了 不⼀致），可能会出现多个客户端同时加到锁的情况 。</p>
<p>框架redisson</p>
<p>流程：</p>
<ol>
<li>尝试获取锁，执行加锁lua脚本。用uuid+自己主线程ID加锁，设置锁过期时间默认30秒</li>
<li>若第一步未获取到锁，则去订阅解锁消息，当获取到锁剩余过期时间后，调用信号量方法堵塞住方法，知道被唤醒或等待超时。</li>
<li>一旦持有锁的线程释放了锁，就会广播解锁消息。第二步堵塞的线程就会被唤醒并重新尝试获取锁。</li>
<li>为了解决锁到期业务可能未执行完的情况，设置定时任务看门狗每隔10s给未完成的业务方法的锁续期30秒。</li>
<li>解锁时，判断是不是自己的锁，不是自己的锁不删除。</li>
</ol>
</li>
</ul>
<p> 代码：<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redisson.lock();</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line"> redisson.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>  <a target="_blank" rel="noopener" href="https://www.cnblogs.com/ludangxin/p/15145779.html">使用案例</a></p>
<p>存在的问题：主从节点不同步，锁丢失。从节点也获取到锁。<br>服务器4个节点不如3个节点。<br>持久化时每隔1秒刷新，机器宕机恢复时锁丢失。<br>解决：<br>    红锁：<br>        三个相等得Redis。<br>        超过半数Redis节点加锁成功才算加速成功。<br>    红锁得坑：<br>        不能配从节点</p>
<p>分布式锁的选择：<br>    Redis锁有时就是会丢失，很严格可以选择性能略低的zookeeper.<br>    参考concurrentHashMap的分段锁</p>
<h3 id="9-用户认证与授权"><a href="#9-用户认证与授权" class="headerlink" title="9.用户认证与授权"></a>9.用户认证与授权</h3><h4 id="介绍-5"><a href="#介绍-5" class="headerlink" title="介绍"></a>介绍</h4><p>认证：也就是说对于每一次访问请求，系统都能判断出访问者是否具有合法的身份标识。（是谁）</p>
<p>AT性）。）而每个资源都有一个拥有者（Resource Owner）。这些资源拥有者所拥有的资源统一存放在资源服务器（Resource Server）中。同时，协议规定需要有一台授权服务器（Authorization Server），即专门用来处理对访问请求进行授权的服务器。</p>
<p>对哪些调用关系进行认证与授权：客户端到服务、从服务到服务。</p>
<h5 id="授权协议OAuth2"><a href="#授权协议OAuth2" class="headerlink" title="授权协议OAuth2"></a>授权协议OAuth2</h5><p>OAuth2 协议中把需要访问的接口或服务统称为资源，而每个资源都有一个拥有者（Resource Owner）。这些资源拥有者所拥有的资源统一存放在资源服务器（Resource Server）中。同时，协议规定需要有一台授权服务器（Authorization Server），即专门用来处理对访问请求进行授权的服务器。</p>
<p>OAuth2 协议在客户端程序和资源服务器之间设置了一个授权层，所以客户端程序不能直接访问资源服务器，而是只能先登录授权层。资源拥有者会首先授权给客户端，客户端获得授权之后，向授权服务器申请一个 Token，Token 中就包含了权限范围和有效期。然后，客户端使用这个申请到的 Token 向资源服务器申请获取资源，资源服务器就根据 Token 的权限范围和有效期向客户端开放拥有者的资源。</p>
<p>对应到微服务系统中，服务提供者所充当的角色就是资源服务器，而服务消费者就是客户端。</p>
<p>OAuth 2.0 定义了四种授权方式，即密码模式、授权码模式、简化模式和客户端模式。</p>
<h5 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h5><p>介绍 博客地址TODO</p>
<h6 id="JJWT使用demo"><a href="#JJWT使用demo" class="headerlink" title="JJWT使用demo"></a>JJWT使用demo</h6><ol>
<li><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jjwt-api&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.11.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jjwt-impl&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.11.2&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jjwt-jackson&lt;/artifactId&gt; &lt;!-- or jjwt-gson if Gson is preferred --&gt;</span><br><span class="line">    &lt;version&gt;0.11.2&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>创建token</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootTest</span><br><span class="line">public class JwtTestor &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 创建Token</span><br><span class="line">     */</span><br><span class="line">    @Test</span><br><span class="line">    public void createJwt()&#123;</span><br><span class="line">        //私钥字符串</span><br><span class="line">        String key = &quot;1234567890_1234567890_1234567890&quot;;</span><br><span class="line">        //1.对秘钥做BASE64编码</span><br><span class="line">        String base64 = new BASE64Encoder().encode(key.getBytes());</span><br><span class="line">        //2.生成秘钥对象,会根据base64长度自动选择相应的 HMAC 算法</span><br><span class="line">        SecretKey secretKey = Keys.hmacShaKeyFor(base64.getBytes());</span><br><span class="line">        //3.利用JJWT生成Token</span><br><span class="line">        String data = &quot;&#123;\&quot;userId\&quot;:123&#125;&quot;; //载荷数据</span><br><span class="line">        String jwt = Jwts.builder().setSubject(data).signWith(secretKey).compact();</span><br><span class="line">        System.out.println(jwt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>验证token</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 校验及提取JWT数据</span><br><span class="line"> */</span><br><span class="line">@Test</span><br><span class="line">public void checkJwt()&#123;</span><br><span class="line">    String jwt = &quot;eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ7XCJ1c2VySWRcIjoxMjN9In0.1p_VTN46sukRJTYFxUg93CmfR3nJZRBm99ZK0e3d9Hw&quot;;</span><br><span class="line">    //私钥</span><br><span class="line">    String key = &quot;1234567890_1234567890_1234567890&quot;;</span><br><span class="line">    //1.对秘钥做BASE64编码</span><br><span class="line">    String base64 = new BASE64Encoder().encode(key.getBytes());</span><br><span class="line">    //2.生成秘钥对象,会根据base64长度自动选择相应的 HMAC 算法</span><br><span class="line">    SecretKey secretKey = Keys.hmacShaKeyFor(base64.getBytes());</span><br><span class="line">    //3.验证Token</span><br><span class="line">    try &#123;</span><br><span class="line">        //生成JWT解析器 </span><br><span class="line">        JwtParser parser = Jwts.parserBuilder().setSigningKey(secretKey).build();</span><br><span class="line">        //解析JWT</span><br><span class="line">        Jws&lt;Claims&gt; claimsJws = parser.parseClaimsJws(jwt);</span><br><span class="line">        //得到载荷中的用户数据</span><br><span class="line">        String subject = claimsJws.getBody().getSubject();</span><br><span class="line">        System.out.println(subject);</span><br><span class="line">    &#125;catch (JwtException e)&#123;</span><br><span class="line">        //所有关于Jwt校验的异常都继承自JwtException</span><br><span class="line">        System.out.println(&quot;Jwt校验失败&quot;);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="Spring-Cloud-Security"><a href="#Spring-Cloud-Security" class="headerlink" title="Spring Cloud Security"></a>Spring Cloud Security</h5><p>实现 OAuth2 协议以及整合 JWT 认证</p>
<h4 id="基于网关的统一用户认证"><a href="#基于网关的统一用户认证" class="headerlink" title="基于网关的统一用户认证"></a>基于网关的统一用户认证</h4><p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/nxyI5Q34c7VdWPs.png" alt="image-20210713220029696"></p>
<h5 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h5><ol>
<li><p>认证中心微服务负责用户认证任务，在启动时从 Nacos 配置中心抽取 JWT 加密用私钥；</p>
</li>
<li><p>用户在登录页输入用户名密码，客户端向认证中心服务发起认证请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 请求示例</span><br><span class="line">http://usercenter/login #认证中心用户认证（登录）地址</span><br></pre></td></tr></table></figure></li>
<li><p>认证中心服务根据输入在用户数据库中进行认证校验，如果校验成功则返回认证中心将生成用户的JSON数据并创建对应的 JWT 返回给客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 响应数据示例</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;code&quot;: &quot;0&quot;,</span><br><span class="line">        &quot;message&quot;: &quot;success&quot;,</span><br><span class="line">        &quot;data&quot;: &#123;</span><br><span class="line">            &quot;user&quot;: &#123;</span><br><span class="line">                &quot;userId&quot;: 1,</span><br><span class="line">                &quot;username&quot;: &quot;zhangsan&quot;,</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;token&quot;: &quot;eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ7XCJ1c2VySWRcIjoxLFwidXNlcm5hbWVcIjpcInpoYW5nc2FuXCIsXCJuYW1lXCI6XCLlvKDkuIlcIixcImdyYWRlXCI6XCJub3JtYWxcIn0ifQ.1HtfszarTxLrqPktDkzArTEc4ah5VO7QaOOJqmSeXEM&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>在收到上述 JSON 数据后，客户端将其中 token 数据保存在 localstorage</p>
</li>
<li><p>客户端向具体某个微服务发起新的请求，这个 JWT 都会附加在请求头或者 cookie 中发往 API 网关，网关将 JWT 再次转发给用户认证服务，此时用户认证服务对 JWT 进行验签，验签成功，查询用户认证与授权的详细数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;code&quot;: &quot;0&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;success&quot;,</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">        &quot;user&quot;: &#123; #用户详细数据</span><br><span class="line">            &quot;userId&quot;: 1,</span><br><span class="line">            &quot;username&quot;: &quot;zhangsan&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;张三&quot;,</span><br><span class="line">            &quot;grade&quot;: &quot;normal&quot;</span><br><span class="line">            &quot;age&quot;: 18,</span><br><span class="line">            &quot;idno&quot; : 130.......,</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;authorization&quot;:&#123; #权限数据</span><br><span class="line">            &quot;role&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;permissions&quot; : [&#123;&quot;addUser&quot;,&quot;delUser&quot;,&quot;...&quot;&#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br></pre></td></tr></table></figure></li>
<li><p>网关根据路由规则将请求与jwt数据和授权数据转发至具体的微服务。</p>
</li>
<li><p>具体的微服务收到上述 JSON 后，对当前执行的操作进行判断，检查是否拥有执行权限，权限检查通过执行业务代码，权限检查失败返回错误响应。</p>
</li>
</ol>
<h5 id="JWT续签"><a href="#JWT续签" class="headerlink" title="JWT续签"></a>JWT续签</h5><p>JWT存在的问题：JWT 生成后失效期是固定的， JWT 的设计本身就不允许生成完全相同的字符串。单靠 JWT  自身特性是无法做到续签。</p>
<p>需解决：很多业务中需要客户端在不改变 JWT 的前提下，实现 JWT 的“续签”功能。</p>
<p>业务问题：10分钟不操作，token失效，跳转登录页面。</p>
<p>解决方案：</p>
<ol>
<li>生成的 JWT  设为“永久生效”。</li>
<li>生成后存到redis集合A中，设置Expire 有效期5分钟。过期后转移到另一个集合B中，有效期5分钟。</li>
<li>前端发起请求不同时间段的处理。<ul>
<li>前端1-5分钟的请求。在redis的集合A中找到携带的token，处理业务。</li>
<li>前端6-10分钟的请求，<ul>
<li>在redis的集合A中未找到携带的token，在集合B中找到了，将集合B中的token移到集合A中。处理业务。</li>
</ul>
</li>
<li>前端超过10分钟的请求。在redis的集合A中未找到携带的token，在集合B中也没找到。返回到登录页面</li>
</ul>
</li>
</ol>
<h2 id="微服务缓存设计"><a href="#微服务缓存设计" class="headerlink" title="微服务缓存设计"></a>微服务缓存设计</h2><p>软件缓存分类：</p>
<ul>
<li>Web应用客户端缓存-浏览器</li>
<li>应用层静态资源缓存-前端-CDN、Nginx</li>
<li>服务层多级缓存-后端-内存（分布式Redis，进程内EhCache）</li>
</ul>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/upX2MQVylkYBsrN.png" alt="image-20210713161053321"></p>
<h3 id="客户端缓存"><a href="#客户端缓存" class="headerlink" title="客户端缓存"></a>客户端缓存</h3><p>浏览器层面我们主要是对 HTML 中的图片、CSS、JS、字体这些静态资源进行缓存。</p>
<p>示例：</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/sWtRIoHXpZx8y1h.png" alt="image-20210713161225780"></p>
<p>通过HTTP 的 Expires 响应头控制静态图片的有效期。百度 Logo 的过期时间为 2031 年 2 月 8 日 9 时 26 分 31 秒。在这个时间段内，浏览器会将图片以文件形式缓存在本地，再次访问时会看到“from disk cache”的提示，此时浏览器不再产生与服务器的实际请求，会从本地直接读取缓存图片。</p>
<h3 id="应用层缓存"><a href="#应用层缓存" class="headerlink" title="应用层缓存"></a>应用层缓存</h3><p>浏览器负责读取Expires响应头， Expires 在应用层设置，也就是 CDN 与 Nginx 中进行设置。</p>
<h4 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h4><h5 id="介绍-6"><a href="#介绍-6" class="headerlink" title="介绍"></a>介绍</h5><p>CDN 全称是 Content Delivery Network，即内容分发网络，是互联网静态资源分发的主要技术手段。</p>
<p><strong>场景：</strong>大量的上海用户同时要访问千里之外的北京服务器的资源，这么长的通信必然带来高延迟与更多不可控因素影响数据传输。</p>
<p><strong>应用：</strong>广域的互联网应用，CDN 几乎是必需的基础设施，它有效解决了带宽集中占用以及数据分发的问题。像 Web 页面中的图片、音视频、CSS、JS 这些静态资源，都可以通过 CDN 服务器就近获取。</p>
<p><strong>CDN执行流程</strong></p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/DSk5GjTXYl7FQBn.png" alt="image-20210713161811213"></p>
<p>在互联网应用中，因为 CDN 涉及多地域多节点组网，前期投入成本较高，更多的中小型软件公司通常会选择阿里云、腾讯云等大厂提供的 CDN 服务，通过按需付费的方式降低硬件成本。</p>
<p>阿里云、腾讯云 CDN 除了缓存文件之外，还提供了管理后台能为响应赋予额外的响应头。如下所示在阿里云 CDN 后台，就额外设置了 Cache-Control 响应头代表缓存有效期为 1 小时。这里我们额外提一下 Expires 与的 Cache-Control 的区别，Expires 是指定具体某个时间点缓存到期，而 Cache-Control 则代表缓存的有效期是多长时间。Expires 设置时间，Cache-Control 设置时长，根据业务场景不同可以使用不同的响应头。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/zxDkd8cNZK4FeBn.png" alt="image-20210713162058257"></p>
<h4 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h4><h5 id="介绍-7"><a href="#介绍-7" class="headerlink" title="介绍"></a>介绍</h5><p>功能：</p>
<ul>
<li>反向代理</li>
<li>负载均衡</li>
<li>静态资源缓存与压缩功能</li>
</ul>
<h5 id="静态资源缓存配置"><a href="#静态资源缓存配置" class="headerlink" title="静态资源缓存配置"></a>静态资源缓存配置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"># 设置缓存目录</span><br><span class="line"></span><br><span class="line"># levels代表采用1:2也就是两级目录的形式保存缓存文件（静态资源css、js）</span><br><span class="line"></span><br><span class="line"># keys_zone定义缓存的名称及内存的使用，名称为babytun-cache ,在内存中开始100m交换空间</span><br><span class="line"></span><br><span class="line"># inactive=7d 如果某个缓存文件超过7天没有被访问，则删除</span><br><span class="line"></span><br><span class="line"># max_size=20g;代表设置文件夹最大不能超过20g，超过后会自动将访问频度（命中率）最低的缓存文件删除</span><br><span class="line"></span><br><span class="line">proxy_cache_path d:/nginx-cache levels=1:2 keys_zone=babytun-cache:100m inactive=7d max_size=20g;</span><br><span class="line"></span><br><span class="line">#配置xmall后端服务器的权重负载均衡策略</span><br><span class="line"></span><br><span class="line">upstream xmall &#123;</span><br><span class="line"></span><br><span class="line">    server 192.168.31.181 weight=5 max_fails=1 fail_timeout=3s;</span><br><span class="line"></span><br><span class="line">    server 192.168.31.182 weight=2;</span><br><span class="line"></span><br><span class="line">    server 192.168.31.183 weight=1;</span><br><span class="line"></span><br><span class="line">    server 192.168.31.184 weight=2;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">	#nginx通过80端口提供Web服务</span><br><span class="line"></span><br><span class="line">	listen 80;</span><br><span class="line"></span><br><span class="line">	# 开启静态资源缓存</span><br><span class="line"></span><br><span class="line">	# 利用正则表达式匹配URL，匹配成功的则执行内部逻辑</span><br><span class="line"></span><br><span class="line">	# ~* 代表URL匹配不区分大小写</span><br><span class="line"></span><br><span class="line">	location ~* \.(gif|jpg|css|png|js|woff|html)(.*)&#123;</span><br><span class="line"></span><br><span class="line">           # 配置代理转发规则</span><br><span class="line"></span><br><span class="line">		proxy_pass http://xmall;</span><br><span class="line"></span><br><span class="line">		proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">		proxy_cache xmall-cache;</span><br><span class="line"></span><br><span class="line">		#如果静态资源响应状态码为200（成功）  302（暂时性重定向）时 缓存文件有效期1天</span><br><span class="line"></span><br><span class="line">		proxy_cache_valid 200 302 24h;</span><br><span class="line"></span><br><span class="line">		#301（永久性重定向）缓存保存5天</span><br><span class="line"></span><br><span class="line">		proxy_cache_valid 301 5d;</span><br><span class="line"></span><br><span class="line">		#其他情况</span><br><span class="line"></span><br><span class="line">		proxy_cache_valid any 5m;</span><br><span class="line"></span><br><span class="line">		#设置浏览器端缓存过期时间90天</span><br><span class="line"></span><br><span class="line">		expires 90d;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	#使用xmall服务器池进行后端处理</span><br><span class="line"></span><br><span class="line">	location /&#123;</span><br><span class="line"></span><br><span class="line">		proxy_pass http://xmall; </span><br><span class="line"></span><br><span class="line">		proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="服务端缓存"><a href="#服务端缓存" class="headerlink" title="服务端缓存"></a>服务端缓存</h3><p>部署方式分类：进程内缓存，分布式缓存</p>
<h5 id="进程内缓存"><a href="#进程内缓存" class="headerlink" title="进程内缓存"></a>进程内缓存</h5><p><strong>介绍：</strong>应用中开辟的一块内存空间，数据在运行时被载入这块内存，通过本地内存的低延迟、高吞吐的特性提高程序的访问速度。</p>
<p><strong>应用场景：</strong>进程内缓存在众多 Java  框架内都有广泛应用，例如 Hibernate、Mybatis 框架的一二级缓存、Spring MVC  的页面缓存都是进程内缓存的经典应用场景。</p>
<p><strong>开源实现：</strong>如 EhCache、Caffeine。</p>
<h5 id="分布式缓存"><a href="#分布式缓存" class="headerlink" title="分布式缓存"></a>分布式缓存</h5><p><strong>介绍：</strong>对多个服务数据的热点数据进行集中缓存。</p>
<p><strong>实现：</strong>基于 Redis 内存型 NoSQL 数据库，对多个应用的热点数据进行集中缓存。</p>
<h5 id="多级缓存"><a href="#多级缓存" class="headerlink" title="多级缓存"></a>多级缓存</h5><p><strong>介绍：</strong>进程内缓存结合分布式缓存。</p>
<p><strong>优点：</strong>性能高，分摊分布式缓存压力。查询相同数据时直接从本地 EhCache 缓存提取，不再产生新的网络通信，应用查询性能得到显著提高。</p>
<p><strong>缺点：</strong>复杂，增加数据一致性问题</p>
<p><strong>场景：</strong></p>
<ul>
<li>缓存的数据是稳定的。例如邮政编码、地域区块、归档的历史数据这些信息适合通过多级缓存减小 Redis 与数据库的压力。</li>
<li>瞬时可能会产生极高并发的场景。例如春运购票、双 11 零点秒杀、股市开盘交易等，瞬间的流量洪峰可能击穿 Redis 缓存，产生流量雪崩。这时利用预热的进程内缓存分摊流量，减少后端压力。</li>
<li>一定程度上允许数据不一致。例如某博客平台中你修改了自我介绍这样的非关键信息，此时在应用集群中其他节点缓存不一致也并不会带来严重影响，对于这种情况我们采用T+1的方式在日终处理时保证缓存最终一致就可以了。</li>
</ul>
<h6 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h6><p>​        在 Java 应用层面，只有 EhCache 的缓存不存在时，再去 Redis 分布式缓存获取，如果 Redis 也没有此数据再去数据库查询，数据查询成功后对 Redis 与 EhCahce 同时进行双写更新。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/rb5SG9kuczNo3Uy.png" alt="image-20210713170806678"></p>
<h6 id="数据一致性问题"><a href="#数据一致性问题" class="headerlink" title="数据一致性问题"></a>数据一致性问题</h6><p>不同应用EhCache数据一致性问题。</p>
<p>解决：引入 MQ 消息队列，利用 RocketMQ 的主动推送功能来向其他服务实例以及 Redis 缓存服务发起变更通知。</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210713171323964.png" alt="image-20210713171323964"></p>
<h2 id="微服务部署"><a href="#微服务部署" class="headerlink" title="微服务部署"></a>微服务部署</h2><h3 id="软件部署发展过程"><a href="#软件部署发展过程" class="headerlink" title="软件部署发展过程"></a>软件部署发展过程</h3><h4 id="物理机部署"><a href="#物理机部署" class="headerlink" title="物理机部署"></a>物理机部署</h4><p>应用程序安装在物理服务器的操作系统中，应用程序直接通过操作系统获取物理服务器的 CPU、内存、硬盘等资源。</p>
<p>缺点：CPU 闲置、内存过剩等资源浪费。物理机价格高</p>
<h4 id="虚拟机部署"><a href="#虚拟机部署" class="headerlink" title="虚拟机部署"></a>虚拟机部署</h4><p>通过 VMWare 或者 VirtualBox 等虚拟化工具，可以将高性能物理服务器切割为若干虚拟机，这些虚拟机拥有自己独立的 CPU、内存、硬盘资源，并且这些资源彼此隔离不允许交叉访问。</p>
<p>运维工程师就可以为不同类型的应用分配不同的资源，如计算密集型的应用就多分配一些 CPU 核数，存储密集型应用就多分配一些内存与硬盘空间，并且这些资源可以在不停机的情况下实现动态调整，让服务器资源得到最大化的利用。</p>
<h4 id="容器化部署"><a href="#容器化部署" class="headerlink" title="容器化部署"></a>容器化部署</h4><p>通过将应用程序镜像化，再通过镜像直接生成一个个容器实现应用的快速部署发布；同时容器化技术不再强调资源隔离，所有容器底层通过 Docker 容器引擎与操作系统获取全局共享的物理机资源。</p>
<p>优点：</p>
<ul>
<li>标准化的部署过程。因为容器化关注应用本身，因此创建容器的过程就是部署应用的过程。容器将是标准化的产物，可能容器内部的应用程序功能各不相同，但对运维人员来说创建容器的命令与操作过程都是基本相同的，可以通过脚本快速批量的完成容器的创建。</li>
<li>更好的性能。相比虚拟机，容器化并不强调资源隔离，物理机的所有资源对于容器都是共享的，容器与底层资源之间通过 Docker 容器引擎与操作系统进行调度，这中间产生的损耗相比虚拟机小得多。</li>
</ul>
<h3 id="软件安装包-容器化技术Docker"><a href="#软件安装包-容器化技术Docker" class="headerlink" title="软件安装包-容器化技术Docker"></a>软件安装包-容器化技术Docker</h3><p>单独写TODO</p>
<h4 id="介绍-8"><a href="#介绍-8" class="headerlink" title="介绍"></a>介绍</h4><p>Docker 是一个开源的应用容器引擎，基于 Go 语言开发。Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，Docker 经过多年发展已经是容器化技术的标准。</p>
<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>镜像，仓库，Dockerfile，容器，容器编排工具</p>
<ul>
<li><h5 id="镜像（Image）"><a href="#镜像（Image）" class="headerlink" title="镜像（Image）"></a>镜像（Image）</h5><p>类似于安装包，可以用安装包安装软件程序。</p>
<p>可以使用镜像在任何安装了 Docker 的 Linux 系统上快速部署应用程序。</p>
<p>jar包打成镜像后，可以用镜像在多个服务器快速部署。</p>
</li>
<li><p>仓库</p>
<p>仓库是存放镜像的地方，Docker 提供了 DockerHub 仓库站托管开发者的镜像文件，开发者可以利用 Pull 命令直接从仓库下载镜像到本地部署。</p>
<p>生产环境需要自己搭建HARBOR 仓库。如同代码仓库GitLab。</p>
</li>
<li><p>Dockerfile</p>
<p>描述将应用程序构建为镜像的过程。如：将jar构建为镜像。</p>
<p>运维可以用镜像屏蔽硬件系统差异在不同实例部署多个应用程序。</p>
</li>
<li><p>容器（Container）</p>
<p>安装包安装成功后是软件（应用程序）。</p>
<p>镜像部署成功后就是容器，容器是镜像的实例。</p>
</li>
<li><p>容器编排工具</p>
<p>容器编排工具的典型代表是 Google Kubernetes(K8S) 和 Docker Swarm，容器编排工具用于管理大规模集群中的容器实例。</p>
<p>服务器网络间自动实现互联互通，随着外部用户的访问压力的变化自动进行容器的扩容与收缩。</p>
<p>K8S 允许运维人员通过可视化的方式对容器进行动态调整，同时对所有运行节点也提供了实时监控。</p>
<p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/ZVtFojsAMT1Jhrb.png" alt="image-20210714122334467"></p>
</li>
</ul>
<p>1.20后k8s放弃了docker部分功能,比如网络与volume,国内基本都是1.1x。</p>
<h3 id="DevOps执行流程"><a href="#DevOps执行流程" class="headerlink" title="DevOps执行流程"></a>DevOps执行流程</h3><p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/K3mRMefYSzPIavo.png" alt="image-20210714113050900"></p>
<p>执行流程：</p>
<ol>
<li>研发工程师将测试验收后的源码上传到 GitLab 服务器，并合并到生成分支（包含 Dockerfile，用来描述 Docker 镜像的构建过程）。</li>
<li>软件工程师或者配置管理员发起 Jekins 的自动化脚本，完成镜像的自动化构建与仓库推送。</li>
<li>上线日运维工程师接入 Kubernetes 管理端，发起 Deploy 部署命令，此时生产环境的 K8S 节点会从 HARBOR 仓库抽取最新版本的应用镜像，并在服务器上自动创建容器，最新版本的 Jar 文件在容器创建时也会随之启动开始对外提供服务。<ol>
<li>抽取新版本源码到 Jekins 服务器，利用 Jekins 服务器安装 Maven 自动完成编译、测试、打包的过程；产出jar文件</li>
<li>抽取 Dockerfile 到 Jekins 服务器，利用 Jekins 服务器安装的 Docker 完成镜像的构建工作，在构建过程中需要将上一步生成的 Jar 文件包含在内，在容器创建时自动执行这个 Jar 文件。</li>
<li>镜像生成后，还是通过 Jekins 服务器上的 Docker 将新版本镜像推送到 HARBOR 仓库。（HARBOR 用于创建 Docker 镜像的私有仓库）</li>
</ol>
</li>
<li>在校验无误后，本次上线宣告成功。</li>
</ol>
<p>真实环境异常因素：</p>
<ul>
<li>源码编译、打包时产生异常的快速应对机制</li>
<li>上线失败如何快速应用回滚</li>
<li>镜像构建失败的异常跟踪与补救措施</li>
</ul>
<h2 id="老项目升级为微服务策略"><a href="#老项目升级为微服务策略" class="headerlink" title="老项目升级为微服务策略"></a>老项目升级为微服务策略</h2><p>单体应用改造升级为微服务架构。</p>
<h3 id="痛点"><a href="#痛点" class="headerlink" title="痛点"></a>痛点</h3><p>分布式事务54%</p>
<p>全链路跟踪43%</p>
<p>服务平滑上下线33%</p>
<h3 id="面临的问题"><a href="#面临的问题" class="headerlink" title="面临的问题"></a>面临的问题</h3><ul>
<li>改造是一步到位还是逐渐迭代？</li>
<li>微服务拆分的粒度是什么？</li>
<li>如何保证数据一致性？</li>
<li>新老交替过程中如何不影响公司业务进展？</li>
</ul>
<h3 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h3><ul>
<li>严禁 Big Bang（一步到位）；</li>
<li>尽早体现价值；</li>
<li>优先分离做前后端；</li>
<li>新功能构建成微服务；</li>
<li>数据源不混用</li>
<li>利用 Spring AOP 开发低侵入的胶水代码；</li>
<li>基于 MQ 构建反腐层。</li>
</ul>
<h3 id="绞杀式升级"><a href="#绞杀式升级" class="headerlink" title="绞杀式升级"></a>绞杀式升级</h3><p>介绍：</p>
<p>​        一个由微服务组成的新应用程序，通过将新功能作为服务，并逐渐从单体应用中提取服务来实现。随着时间的推移，越来越多单体应用内的功能被逐渐剥离为独立的微服务，最终达到消灭单体应用的目的。</p>
<p>优点：</p>
<ul>
<li>升级改造过程中并不需要推翻原有的代码，而是在新老更迭的过程中一步步完成微服务架构的升级改造。</li>
<li>立即获得投资回报。</li>
</ul>
<h4 id="严禁-Big-Band"><a href="#严禁-Big-Band" class="headerlink" title="严禁 Big Band"></a>严禁 Big Band</h4><p>逐步重构单体应用，采用绞杀者应用策略，将应用变为单体与微服务的混合状态，随着时间增加一点点蚕食掉单体应用。</p>
<h4 id="尽早体现价值"><a href="#尽早体现价值" class="headerlink" title="尽早体现价值"></a>尽早体现价值</h4><p>按价值的重要性进行排序。</p>
<h4 id="优先分离做前后端"><a href="#优先分离做前后端" class="headerlink" title="优先分离做前后端"></a>优先分离做前后端</h4><p>前后端独立部署、扩展与维护。表示层在快速迭代部署时并不影响后端功能，可以轻松进行 A/B 测试。</p>
<h4 id="新功能构建成微服务"><a href="#新功能构建成微服务" class="headerlink" title="新功能构建成微服务"></a>新功能构建成微服务</h4><p>例如检索服务。增加了 API Gateway 网关，该网关对前端访问的 URL 进行路由。访问 search 接口，则请求被重定向到新创建的商品检索微服务，通过 ElasticSearch 这种专用的全文检索引擎提供更高级的查询功能；</p>
<h4 id="数据源不混用"><a href="#数据源不混用" class="headerlink" title="数据源不混用"></a>数据源不混用</h4><p>可使用 Alibaba Canal 做数据源同步，Canal 是阿里巴巴旗下的开源项目，纯 Java 开发。基于数据库增量日志解析，提供增量数据订阅&amp;消费，可自动实现从 MySQL 数据源向其他数据源同步数据的任务。</p>
<h4 id="旧功能修改"><a href="#旧功能修改" class="headerlink" title="旧功能修改"></a>旧功能修改</h4><h5 id="Spring-AOP-扩展"><a href="#Spring-AOP-扩展" class="headerlink" title="Spring AOP 扩展"></a>Spring AOP 扩展</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Component(&quot;priceServiceAspect&quot;) //声明Bean Id</span><br><span class="line">@Aspect //定义切面类</span><br><span class="line">public class PriceServiceAspect&#123;</span><br><span class="line">    @Resource</span><br><span class="line">    private PriceServiceFeignClient priceServiceFeignClient;</span><br><span class="line">    //利用环绕通知实现对PriceService.findByGoodsId的动态代理</span><br><span class="line">    @Around(&quot;execution(* com.lagou..PriceService.findByGoodsId(..)&quot;)</span><br><span class="line">    public Object selectGoods(ProceedingJoinPoint joinPoint)&#123;</span><br><span class="line">        //通过OpenFeign客户端向定价服务发起远程请求，替代JVM本地访问</span><br><span class="line">        return priceServiceFeignClient.selectGoods((Long)joinPoint.getArgs()[0]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="MQ构建反腐层"><a href="#MQ构建反腐层" class="headerlink" title="MQ构建反腐层"></a>MQ构建反腐层</h5><p><img src="https://xiaoruiit.oss-cn-beijing.aliyuncs.com/img/pxrasmLu1MYvRcS.png" alt="image-20210713214025802"></p>
<h2 id="分布式sql"><a href="#分布式sql" class="headerlink" title="分布式sql"></a>分布式sql</h2><p> 不使用join而使用in,不同mysql实例不能使用join</p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="追逐 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="追逐 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>追逐
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://blog.xiaoruiit.com/2020/07/08/213Java%E6%A1%86%E6%9E%B6/SpringCloud/" title="SpringCloud">http://blog.xiaoruiit.com/2020/07/08/213Java框架/SpringCloud/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa%204.0/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%85%A5%E9%97%A8/" rel="tag"># 入门</a>
              <a href="/tags/SpringCloud/" rel="tag"># SpringCloud</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/06/12/%E5%8D%9A%E5%AE%A2/%E9%87%8D%E6%96%B0%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/" rel="prev" title="重新搭建博客">
      <i class="fa fa-chevron-left"></i> 重新搭建博客
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/07/18/214%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql-%E5%9F%BA%E7%A1%80+%E6%9E%B6%E6%9E%84/" rel="next" title="Mysql-基础+架构">
      Mysql-基础+架构 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zNTcwNC8xMjI0MA=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringCloud"><span class="nav-number">1.</span> <span class="nav-text">SpringCloud</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%84%E4%B8%AA%E7%BB%84%E4%BB%B6"><span class="nav-number">1.1.</span> <span class="nav-text">各个组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83Nacos"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.注册中心Nacos</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%B9%E6%80%A7"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%BD%BF%E7%94%A8"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">Nacos注册中心使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%83%A8%E7%BD%B2"><span class="nav-number">1.1.1.2.1.</span> <span class="nav-text">服务端部署</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5nacos"><span class="nav-number">1.1.1.2.2.</span> <span class="nav-text">微服务接入nacos</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">Nacos配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.1.3.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">1.1.1.3.2.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">1.1.1.3.2.1.</span> <span class="nav-text">部署配置中心</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">1.1.1.3.2.2.</span> <span class="nav-text">微服务接入配置中心</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.1.3.2.3.</span> <span class="nav-text">高级配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nacos%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.1.4.</span> <span class="nav-text">Nacos原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">1.1.1.4.1.</span> <span class="nav-text">心跳机制与健康检查</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%83%AD%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.1.4.2.</span> <span class="nav-text">热加载原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%AB%98%E5%8F%AF%E7%94%A8-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1Ribbon"><span class="nav-number">1.1.2.</span> <span class="nav-text">2.微服务高可用-负载均衡Ribbon</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ribbon-%E4%BD%BF%E7%94%A8"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">Ribbon-使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#demo"><span class="nav-number">1.1.2.2.1.</span> <span class="nav-text">demo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.2.2.2.</span> <span class="nav-text">负载均衡策略配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9%E7%AD%96%E7%95%A5"><span class="nav-number">1.1.2.2.3.</span> <span class="nav-text">配置文件修改策略</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%9C%8D%E5%8A%A1%E9%97%B4%E9%80%9A%E4%BF%A1OpenFeign"><span class="nav-number">1.1.3.</span> <span class="nav-text">3.服务间通信OpenFeign</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OpenFeign%E4%BD%BF%E7%94%A8"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">OpenFeign使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#demo-1"><span class="nav-number">1.1.3.1.1.</span> <span class="nav-text">demo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#OpenFeign%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.1.3.1.2.</span> <span class="nav-text">OpenFeign执行流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE-1"><span class="nav-number">1.1.3.1.3.</span> <span class="nav-text">高级配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E7%B1%BB%E4%BA%A7%E5%93%81Dubbo"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">同类产品Dubbo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%A4%A7%E9%97%A8-%E7%BD%91%E5%85%B3GateWay"><span class="nav-number">1.1.4.</span> <span class="nav-text">4.微服务大门-网关GateWay</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-2"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF"><span class="nav-number">1.1.4.1.1.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E4%BD%9C%E7%94%A8"><span class="nav-number">1.1.4.1.2.</span> <span class="nav-text">网关作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Gateway%E7%89%B9%E7%82%B9"><span class="nav-number">1.1.4.1.3.</span> <span class="nav-text">Gateway特点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%89%8D%E6%8F%90"><span class="nav-number">1.1.4.2.1.</span> <span class="nav-text">前提</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Gatway-demo"><span class="nav-number">1.1.4.2.2.</span> <span class="nav-text">Gatway-demo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE-2"><span class="nav-number">1.1.4.2.3.</span> <span class="nav-text">高级配置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%B0%93%E8%AF%8D"><span class="nav-number">1.1.4.2.3.1.</span> <span class="nav-text">谓词</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">1.1.4.2.3.2.</span> <span class="nav-text">过滤器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B"><span class="nav-number">1.1.4.2.3.3.</span> <span class="nav-text">实例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.4.3.</span> <span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%BD%AC%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="nav-number">1.1.4.3.1.</span> <span class="nav-text">路由转发流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.4.3.2.</span> <span class="nav-text">内部执行原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%9C%8D%E5%8A%A1%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6Sentinel"><span class="nav-number">1.1.5.</span> <span class="nav-text">5.服务流量控制Sentinel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sentinel%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">Sentinel介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sentinel%E4%BD%BF%E7%94%A8"><span class="nav-number">1.1.5.3.</span> <span class="nav-text">Sentinel使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#demo-2"><span class="nav-number">1.1.5.3.1.</span> <span class="nav-text">demo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dashboard%E9%99%90%E6%B5%81%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.5.3.2.</span> <span class="nav-text">Dashboard限流配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dashboard%E7%86%94%E6%96%AD%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.5.3.3.</span> <span class="nav-text">Dashboard熔断配置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-3"><span class="nav-number">1.1.5.3.3.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E8%BF%87%E7%A8%8B"><span class="nav-number">1.1.5.3.3.2.</span> <span class="nav-text">熔断过程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E8%AE%BE%E7%BD%AE"><span class="nav-number">1.1.5.3.3.3.</span> <span class="nav-text">熔断设置</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Sentinel%E4%B8%8ENacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%95%B4%E5%90%88"><span class="nav-number">1.1.5.3.4.</span> <span class="nav-text">Sentinel与Nacos配置中心整合</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%95%B4%E5%90%88-%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">1.1.5.3.4.1.</span> <span class="nav-text">整合-流控规则持久化</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E6%B5%81%E6%8E%A7"><span class="nav-number">1.1.5.3.5.</span> <span class="nav-text">自定义资源流控</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sentinel%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.5.4.</span> <span class="nav-text">Sentinel原理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%BA%94%E7%94%A8%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7SkyWalking"><span class="nav-number">1.1.6.</span> <span class="nav-text">6.应用性能监控SkyWalking</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sleuth-Zipkin"><span class="nav-number">1.1.6.1.</span> <span class="nav-text">Sleuth+Zipkin</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Tracer-%E5%9C%A8%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E4%B8%AD%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-Span"><span class="nav-number">1.1.6.1.1.</span> <span class="nav-text">使用 Tracer 在访问链路中创建自定义的 Span</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1Seata"><span class="nav-number">1.1.7.</span> <span class="nav-text">7.分布式事务Seata</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-4"><span class="nav-number">1.1.7.1.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0"><span class="nav-number">1.1.7.1.1.</span> <span class="nav-text">产生原因</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.1.7.1.2.</span> <span class="nav-text">分布式解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4"><span class="nav-number">1.1.7.1.2.1.</span> <span class="nav-text">三阶段提交</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Seata"><span class="nav-number">1.1.7.1.3.</span> <span class="nav-text">Seata</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="nav-number">1.1.7.2.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2TC-Seata-Server"><span class="nav-number">1.1.7.2.1.</span> <span class="nav-text">部署TC-Seata-Server</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%80%E5%8F%91RM%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">1.1.7.2.2.</span> <span class="nav-text">开发RM资源管理器</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.7.2.2.1.</span> <span class="nav-text">订单服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#rm-points-%E7%A7%AF%E5%88%86%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.7.2.2.2.</span> <span class="nav-text">rm-points 积分服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#rm-storage-%E5%BA%93%E5%AD%98%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.7.2.2.3.</span> <span class="nav-text">rm-storage 库存服务</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%80%E5%8F%91TM-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">1.1.7.2.3.</span> <span class="nav-text">开发TM 事务管理器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-number">1.1.7.2.4.</span> <span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-1"><span class="nav-number">1.1.7.3.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%B1%E6%95%88"><span class="nav-number">1.1.7.4.</span> <span class="nav-text">失效</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="nav-number">1.1.8.</span> <span class="nav-text">8.分布式锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.1.8.1.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="nav-number">1.1.8.2.</span> <span class="nav-text">实现方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83"><span class="nav-number">1.1.9.</span> <span class="nav-text">9.用户认证与授权</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-5"><span class="nav-number">1.1.9.1.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E5%8D%8F%E8%AE%AEOAuth2"><span class="nav-number">1.1.9.1.1.</span> <span class="nav-text">授权协议OAuth2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JWT"><span class="nav-number">1.1.9.1.2.</span> <span class="nav-text">JWT</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#JJWT%E4%BD%BF%E7%94%A8demo"><span class="nav-number">1.1.9.1.2.1.</span> <span class="nav-text">JJWT使用demo</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Spring-Cloud-Security"><span class="nav-number">1.1.9.1.3.</span> <span class="nav-text">Spring Cloud Security</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E7%BD%91%E5%85%B3%E7%9A%84%E7%BB%9F%E4%B8%80%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="nav-number">1.1.9.2.</span> <span class="nav-text">基于网关的统一用户认证</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.1.9.2.1.</span> <span class="nav-text">执行流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JWT%E7%BB%AD%E7%AD%BE"><span class="nav-number">1.1.9.2.2.</span> <span class="nav-text">JWT续签</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.2.</span> <span class="nav-text">微服务缓存设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98"><span class="nav-number">1.2.1.</span> <span class="nav-text">客户端缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82%E7%BC%93%E5%AD%98"><span class="nav-number">1.2.2.</span> <span class="nav-text">应用层缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CDN"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">CDN</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-6"><span class="nav-number">1.2.2.1.1.</span> <span class="nav-text">介绍</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nginx"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">Nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-7"><span class="nav-number">1.2.2.2.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.2.2.2.</span> <span class="nav-text">静态资源缓存配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BC%93%E5%AD%98"><span class="nav-number">1.2.3.</span> <span class="nav-text">服务端缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E5%86%85%E7%BC%93%E5%AD%98"><span class="nav-number">1.2.3.0.1.</span> <span class="nav-text">进程内缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98"><span class="nav-number">1.2.3.0.2.</span> <span class="nav-text">分布式缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">1.2.3.0.3.</span> <span class="nav-text">多级缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.2.3.0.3.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="nav-number">1.2.3.0.3.2.</span> <span class="nav-text">数据一致性问题</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="nav-number">1.3.</span> <span class="nav-text">微服务部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2%E5%8F%91%E5%B1%95%E8%BF%87%E7%A8%8B"><span class="nav-number">1.3.1.</span> <span class="nav-text">软件部署发展过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">物理机部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">虚拟机部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">容器化部署</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85%E5%8C%85-%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AFDocker"><span class="nav-number">1.3.2.</span> <span class="nav-text">软件安装包-容器化技术Docker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-8"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">概念</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%EF%BC%88Image%EF%BC%89"><span class="nav-number">1.3.2.2.1.</span> <span class="nav-text">镜像（Image）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DevOps%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.3.3.</span> <span class="nav-text">DevOps执行流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%80%81%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7%E4%B8%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%AD%96%E7%95%A5"><span class="nav-number">1.4.</span> <span class="nav-text">老项目升级为微服务策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%97%9B%E7%82%B9"><span class="nav-number">1.4.1.</span> <span class="nav-text">痛点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.4.2.</span> <span class="nav-text">面临的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%96%E7%95%A5"><span class="nav-number">1.4.3.</span> <span class="nav-text">策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9E%E6%9D%80%E5%BC%8F%E5%8D%87%E7%BA%A7"><span class="nav-number">1.4.4.</span> <span class="nav-text">绞杀式升级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A5%E7%A6%81-Big-Band"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">严禁 Big Band</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%BD%E6%97%A9%E4%BD%93%E7%8E%B0%E4%BB%B7%E5%80%BC"><span class="nav-number">1.4.4.2.</span> <span class="nav-text">尽早体现价值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%85%88%E5%88%86%E7%A6%BB%E5%81%9A%E5%89%8D%E5%90%8E%E7%AB%AF"><span class="nav-number">1.4.4.3.</span> <span class="nav-text">优先分离做前后端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%8A%9F%E8%83%BD%E6%9E%84%E5%BB%BA%E6%88%90%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.4.4.4.</span> <span class="nav-text">新功能构建成微服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8D%E6%B7%B7%E7%94%A8"><span class="nav-number">1.4.4.5.</span> <span class="nav-text">数据源不混用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A7%E5%8A%9F%E8%83%BD%E4%BF%AE%E6%94%B9"><span class="nav-number">1.4.4.6.</span> <span class="nav-text">旧功能修改</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Spring-AOP-%E6%89%A9%E5%B1%95"><span class="nav-number">1.4.4.6.1.</span> <span class="nav-text">Spring AOP 扩展</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MQ%E6%9E%84%E5%BB%BA%E5%8F%8D%E8%85%90%E5%B1%82"><span class="nav-number">1.4.4.6.2.</span> <span class="nav-text">MQ构建反腐层</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8Fsql"><span class="nav-number">1.5.</span> <span class="nav-text">分布式sql</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">追逐</p>
  <div class="site-description" itemprop="description">技术融于生活</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">158</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">112</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">追逐</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>
        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"S5VAuYJ1IwlShaxWk8a4FHBc-gzGzoHsz","app_key":"4uuoVMQeqKxIXcX7xwgWjGat","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
